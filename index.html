<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>E1</title>
    <style type="text/css" media="screen">
        body {
            padding: 0;
            margin: 0;
        }

        canvas {
            display: block;
        }

    </style>
</head>

<body>

<canvas id="canvasOne" width="window.innerHeight" height= "window.innerHeight">
 <input type="file" id="input" style="visibility: hidden" accept="image/*"/>
</canvas>
<script>
    window.addEventListener('load', eventWindowLoaded, false);
   


    var Debugger = function() {};

    Debugger.log = function(message) {
        try {
           // console.log(message);
        } catch (exception) {

        }
    }
    
    function eventWindowLoaded() {

        canvasApp();




    }
    let e = null;

    class ec {
        wai=false;
        count=null;
        first = true;
        type = [];
        bit = [];
        value = [];
        str = [];
        font = [];
        fsize = [];
        x1 = [];
        y1 = [];
        x2 = [];
        y2 = [];
        col = [];


        sdx= [];
        sdy= [];
        dx = [];
        dy = [];

        sx = [];
        sy = [];
        k = [];

        an = [];
        sp = [];
        n = [];

        zm = [];
        rot = [];


        mx;
        my;
        mx1;
        my1;
        mx2;
        my2;
        mx3;
        my3;

        mstate=[];


        drx = [];
        dry = [];

        curved = [];
        chd = [];

        refresh = [];
        id = [];
        mrk = [];


        type1 = [];
        bit1 = [];
        value1 = [];
        str1 = [];
        font1 = [];
        fsize1 = [];
        x11 = [];
        y11 = [];
        x21 = [];
        y21 = [];
        col1 = [];

        dx1 = [];
        dy1 = [];
        sx1 = [];
        sy1 = [];
        k1 = [];

        stx1 = [];
        sty1 = [];

        sdrx1 = [];
        sdry1 = [];


        an1 = [];
        sp1 = [];
        n1 = [];

        zm1 = [];
        rot1 = [];

        mweel=[];

        mvx ;
        mvy ;

        curved1 = [];
        chd1 = [];

        refresh1 = [];
        id1 = [];
        mrk1 = [];
 
        value=[]


        count = 0;

        key=0;
        x; y;
        stx;sty;
        wi=0;
        nad=0;
        w; h;

        pindex=0;
        waitstart=false;


        // refresh;

        fx1 = 12000;
        fy1 = 12000;
        fx2 = 1;
        fy2 = 1;
        wci = 0;
        ini = false;

        ex1;
        ex2;
        ey1;
        ey2;
        esc;
        epi;
        id = [];

        bind = 0;
        bitmaps = []
         paths = [];
         
        
        fonts = []
        fpaths = [];
        pat;
        marki;

        wci
        wcx1
        wcy1
        wcx2
        wcy2
        wzm
        wdx=0;
        wdy=0;

        wmvx=0;
        wmvy=0;
        key=0;//mouse key

        wover=0;//nad kakim scrollom
        pressedw=0;
        pressedo=0;
        ctx;
        wweel=0;

        noscroll=false;//otmenit scrolling naprimer pri dviganii elem
        mousetop=0;//samiy verhniy obj clicked
        alert1='';
        stox=0;
        stoy=0;
        pinchx=0
        pinchy=0
        pinchd=0

        tcanvas=null;

        loading=false;

        szm=1.0;


        distance = (event) => {
            return Math.hypot(event.touches[0].pageX - event.touches[1].pageX, event.touches[0].pageY - event.touches[1].pageY);
        };


        old=undefined;
        deb=function(ind,us){
            if(ind!=this.old&&us){
                this.old=ind
                debugger
            }
        }

    fitw=function(ind){
		this.zm[ind]=(this.x2[ind]-this.x1[ind])/this.sx[ind];
		this.refresh[ind]=1;
	}
	fith=function(ind){
        this.zm[ind]=(this.y2[ind]-this.y1[ind])/this.sy[ind];
		//this.dx[ind]=((this.sy[ind]/2.0)-((this.x2[ind]-this.x1[ind])/2.0));
        this.refresh[ind]=1;
	}


        clicked=(i)=> {
            return mousedown(i);
        }

mousedown=(i)=> {

if(this.key==1){
   
if(this.type[i]==8){
  if (this.x > this.x1[i] && this.y > this.y1[i] && this.x < this.x2[i]&& this.y < this.y2[i]) {  
    this.mstate[i]=1;
   // this.dri=i;
    //console.log("window="+this.type[i])
   this.mx=((this.x-this.x1[i])/this.zm[i])-this.dx[i];
   this.my=((this.y-this.y1[i])/this.zm[i])-this.dy[i];
   
      
      return true;
  }
} else
if(this.type[i]==5){
    
  if (this.x > this.x1[i] && this.y > this.y1[i] && this.x < this.x2[i]&& this.y < this.y2[i]) {
    this.mstate[i]=1;
    //console.log("overl="+this.type[i])
   // this.dri=i;
//console.log(this.type[i])
   this.mx=(this.x-this.x1[i]);
   this.my=(this.y-this.y1[i]);
   
    
      return true;
  }
} else{

//console.log("cli "+this.type[this.wi]);
    if(this.type[this.wi]==8){
     this.mx=((this.x-this.x1[this.wi])/this.zm[this.wi])-this.dx[this.wi];
     this.my=((this.y-this.y1[this.wi])/this.zm[this.wi])-this.dy[this.wi];

    }else {
        this.mx=this.x//(this.x-this.x1[this.wi]);
        this.my=this.y//(this.y-this.y1[this.wi]);
    }
   //if(this.type[this.wci]==5)console.log("isin="+this.isin(this.wci)+" i="+i+" mx="+this.mx+" my="+this.my+" "+this.x1[i]+" "+this.y1[i]+" "+this.x2[i]+" "+this.y2[i]);
   if (this.isin(this.wci)&&this.mx > this.x1[i] && this.my > this.y1[i] && this.mx < this.x2[i]&& this.my < this.y2[i]) {
       this.mstate[i]=1;
      //this.dri=i;
//console.log("i="+i+" mx"+this.mx+" my"+this.my+" x1"+this.x1[i]+" y1"+this.y1[i]+" x2"+this.x2[i]+" y2"+this.y2[i])
//console.log("obj i="+i)
      this.mx=this.mx-this.x1[i];
      this.my=this.my-this.y1[i];

     return true;
   }

}

}
return false;
}



mousemove=(i)=> { 

   

if(this.key==2&&(this.stx!=this.x||this.sty!=this.y)){ 

if(this.type[i]==8){

  if (this.x > this.x1[i] && this.y > this.y1[i] && this.x < this.x2[i]&& this.y < this.y2[i]) {
    this.mstate[i]=2;
   
   this.mx=((this.x-this.x1[i])/this.zm[i])-this.dx[i];
   this.my=((this.y-this.y1[i])/this.zm[i])-this.dy[i];

   this.mx1=((this.x-this.x1[i])/this.zm[i]);
   this.my1=((this.y-this.y1[i])/this.zm[i]);
   this.mvx=(this.x-this.stx)/this.zm[i];
   this.mvy=(this.y-this.sty)/this.zm[i];
     
        //  this.mvx=this.mvx[i];this.mvy=this.mvy[i];
       
      return true;
  }
} else
if(this.type[i]==5){
  if (this.x > this.x1[i] && this.y > this.y1[i] && this.x < this.x2[i]&& this.y < this.y2[i]) {
   this.mstate[i]=2;
   this.mx=(this.x-this.x1[i]);
   this.my=(this.y-this.y1[i]);
  this.mx1=((this.x-this.x1[i])/this.zm[i]);
  this.my1=((this.y-this.y1[i])/this.zm[i]);           
  this.mvx=(this.x-this.stx)/this.zm[i];
   this.mvy=(this.y-this.sty)/this.zm[i];
   

      return true;
  }
} else{

    
    for(let j=i;j>0;j--){
         // if(this.type[j]==5||this.type[j]==5||j==0){this.wi=j;}
        }
    if(this.type[this.wi]==8){
     this.mx=((this.x-this.x1[this.wi])/this.zm[this.wi])-this.dx[this.wi];
     this.my=((this.y-this.y1[this.wi])/this.zm[this.wi])-this.dy[this.wi];
     this.mx1=((this.x-this.x1[this.wi])/this.zm[this.wi]);
     this.my1=((this.y-this.y1[this.wi])/this.zm[this.wi]);  

     
    }else {
        this.mx=(this.x-this.x1[this.wi]);
        this.my=(this.y-this.y1[this.wi]);
        this.mx1=((this.x-this.x1[this.wi])/this.zm[this.wi]);
        this.my1=((this.y-this.y1[this.wi])/this.zm[this.wi]);  
    }
    
    console.log("mx1="+this.mx1+" my1="+this.my1)
    console.log("x1="+this.x1[i]+" y1="+this.y1[i]+" x2="+this.x2[i]+" y2="+this.y2[i])
   if (this.mx > this.x1[i] && this.my > this.y1[i] && this.mx < this.x2[i]&& this.my< this.y2[i]) {
      this.mstate[i]=2;
      this.mx1=this.mx1-this.x1[i];
      this.my1=this.my1-this.y1[i];
      this.mvx=(this.x-this.stx)/this.zm[i];
      this.mvy=(this.y-this.sty)/this.zm[i];
   

     return true;
   }

}
return false;

}


        }






mousedrag=(i)=> { 
    
    if(this.isin(i)){
       
      if(this.type[i]==8){
          

        if(this.mousemove(i)) { 
         // console.log("scrol");

          return true;
        }
    }else 
    if(this.type[i]==5){
        if(this.mousemove(i)) {console.log("overl");
          return true;
        }
    }


/*
    if(this.type[this.wi]==8){
         this.mx=((this.x-this.x1[this.wi])/this.zm[this.wi])-this.dx[this.wi];
         this.my=((this.y-this.y1[this.wi])/this.zm[this.wi])-this.dy[this.wi];
         this.mvx=(this.x-this.stx)/this.zm[this.wi];
         this.mvy=(this.y-this.sty)/this.zm[this.wi];console.log(this.mvx+" 8 "+this.mvy)
        
    }else {
        this.mx=(this.x-this.x1[this.wi]);
        this.my=(this.y-this.y1[this.wi]);
        this.mvx=(this.x-this.stx)/this.zm[this.wi];
        this.mvy=(this.y-this.sty)/this.zm[this.wi];console.log(this.mvx+" 5 "+this.mvy)
       
    }*/
     
   if (this.mousemove(i)) {
   
      this.mx=this.mx-this.x1[i];
      this.my=this.my-this.y1[i];
   //this.mvx=(this.x-this.stx)/this.zm[i];
   //this.mvy=(this.y-this.sty)/this.zm[i];
  console.log("dragingon- "+this.mvx+" "+this.mvy)
     return true;
   }
}
       return false; 
 }



 mousedragon=(i)=> {
    if(this.wi==i){
      if(this.type[i]==8){
        if(this.mousemove(i)) {
          return true;
        }
    }else 
    if(this.type[i]==5){
        if(this.mousemove(i)) {
          return true;
        }
    }
    }
   
if(this.dri==i){
   if (this.mousemove(this.wi)&&this.mx > this.x1[i] && this.my > this.y1[i] && this.mx < this.x2[i]&& this.my < this.y2[i]) {

      this.mx=this.mx-this.x1[i];
      this.my=this.my-this.y1[i];
   this.mvx=(this.x-this.stx)/this.zm[i];
   this.mvy=(this.y-this.sty)/this.zm[i];
   console.log("draging- "+this.mvx+" "+this.mvy)
     return true;
   }
}
       return false; 
 }



draged=(i)=> {
    return this.mousedrag(i);
}



        mouseup=(ind)=> {

           
           return(this.key==0);
        
        }



        mouseweel=function(){
            if(this.mweel[this.pindex]==undefined)return false;
            if(this.mweel[this.pindex]!=0){
                this.wweel =this.mweel[this.pindex];
                this.mweel[this.pindex]=0;
                return true;
            } else {
                return false;}

        }
        mouseweel=function(ind){
            if(this.mweel[ind]==undefined)return false;
            if(this.mweel[ind]!=0&&this.mstate[ind]==5){
                //console.log("zm")
                this.wweel =this.mweel[ind];
                this.mweel[ind]=0;
                return true;
            } else {
                return false;}

        }
        pinchzoom=function(ind){
            if(this.mweel[ind]==undefined)return false;
            if(this.mweel[ind]!=0&&this.mstate[ind]==6){
                
                //alert(this.mweel[ind])
                this.wweel =this.mweel[ind]
//console.log("zm "+this.wweel)
                this.mweel[ind]=0;
                this.mstate[ind]=0
                return true;
            } else {
                return false;}

        }
  
changed=(ind)=> {
            if(this.chd[ind]) {
                this.chd[ind]=false;
                return true;
            } else {
                return false;
            }
 }
 prind=0;//index of pressed
 timems=0;//ms
 
        pressed=(ind)=> {
            
    
          if(this.key==7){
              
           //  console.log(ind+"  "+this.isin(ind))
              
               if(this.isin(ind)){this.clcount=0; this.key=0;
               return true;} else return false;
          }
        }
       

        







        scroll=function(ind) {
        
             if(isNaN(this.mvx)||isNaN(this.mvy)){this.mvx=0;this.mvy=0;return;}
                e.dx[ind] +=this.mvx;
                e.dy[ind] +=this.mvy; 
//console.log("ind="+ind+" "+this.wi );

                
             //    console.log("move="+this.mvx+" "+this.mvy);

        }

        block=function(wind) {
        
           if((-e.dx[wind]+(e.x2[wind]-e.x1[wind]))>e.sx[wind]) e.dx[wind]=-(e.sx[wind]-(e.x2[wind]-e.x1[wind]));
           if((-e.dy[wind]+(e.y2[wind]-e.y1[wind]))>e.sy[wind]) e.dy[wind]=-(e.sy[wind]-(e.y2[wind]-e.y1[wind]));
           if(e.dx[wind]>0) e.dx[wind]=0;
           if(e.dy[wind]>0) e.dy[wind]=0;
        }


        selecttodrag=function(ind) {
            e.sdx[ind]=e.x1[ind]// / e.zm[e.pindex];
            e.sdy[ind]=e.y1[ind] /// e.zm[e.pindex];
        }

        processcrolling=function(wind) {

           // 
          if(this.noscroll==false){ //console.log(wind+" "+this.wi)
            if(this.mousedrag(wind)){ 
               
              

                this.scroll(wind);
            }
            
          }
          
        }
        processzooming=function(wind) {
            if(this.mouseweel(wind)){
            if(this.wweel<0){
                this.zm[wind]*=1.05
              //  console.log(e.zm[e.pindex])
            }else if(this.wweel>0){
                this.zm[wind]*=0.95
               // console.log(e.zm[e.pindex])
            }
            
            }

            if(this.pinchzoom(wind)){
                
                this.zm[wind]=this.wweel;
//console.log("pz "+this.pinchd+" "+this.wweel)
                
                
            }



        }

NOZOOM=99;
stime=0;
scrollbox=false;

clcount=0;
cli=[];
clm=[];
clx=[];
cly=[]; 

addcl=function(ind,x,y){
    //console.log(this.type[ind]+" "+x+" "+y+" ")
 this.clcount++;
this.cli[this.clcount]=ind;
this.clx[this.clcount]=x;
this.cly[this.clcount]=y;


}

isin=function(ind){
 let yes=false;
 for(let i=1;i<=this.clcount;i++){

     
   if(this.cli[i]==ind){yes=true;break;}
    
 }
 return yes;
}


mousedownevent=function(x,y){
  
   this.key=1;
   this.timems=performance.now();
   this.x=x;
   this.y=y;
   this.stx=x;
   this.sty=y;
   
 for(let i=1;i<=this.count;i++){
    
   if(this.type[i]==8){
     if(x>this.x1[i]&&x<this.x2[i]&&y>this.y1[i]&&y<this.y2[i]){
          this.addcl(i,x,y);
          this.wi=i;
     }
   }else
   if(this.type[i]==5){
       //console.log("x="+x+" y="+y+" "+this.x1[i]+" "+this.y1[i]+" "+this.x2[i]+" "+this.y2[i])
     if(x>this.x1[i]&&x<this.x2[i]&&y>this.y1[i]&&y<this.y2[i]){
        this.addcl(i,x,y);
        this.wi=i;
     }
   }
 }//for
    let ii=this.wi+1;//console.log("click")
   if(this.type[ii]==8||this.type[ii]==5)return;
   let inx=0;
   let iny=0;
   if(this.type[this.wi]==8){
     inx=((this.x-this.x1[this.wi])/this.zm[this.wi])-this.dx[this.wi];
     iny=((this.y-this.y1[this.wi])/this.zm[this.wi])-this.dy[this.wi];
    
    }else {
        inx=this.x//(this.x-this.x1[this.wi]);
        iny=this.y//(this.y-this.y1[this.wi]);
   } 
   
  // console.log("inx= "+inx+" iny= "+iny)
   do{
    if(this.type[ii]==8||this.type[ii]==5)break;
    if(inx>this.x1[ii]&&inx<this.x2[ii]&&iny>this.y1[ii]&&iny<this.y2[ii]){
        //console.log("add  "+this.type[ii])
        this.addcl(ii,inx,iny);
    }
    ii++;
   }while(this.type[ii]!=8&&this.type[ii]!=5&&ii<=this.count);





   





   
}





mouseupevent=function(x,y){
    //console.log("UP")
    
    let delay=performance.now()-this.timems;

if(delay>200){
    
    
  this.key=0;this.clcount=0;
    
    
    
}else {this.key=7;
    
    
    
}
  


   this.x=0;
   this.y=0; 
   this.stx=0;
   this.sty=0; 
   this.noscroll=false;
   this.wi=0;
   this.dri=0;
   this.mvx=0;
   this.mvy=0;

}


mousemoveevent=function(e,x,y){

if(e.buttons==0&&performance.now()-this.timems<60)return false;

   this.key=2;
  
   this.x=x;
   this.y=y;
 
   for(let i=this.count;i>0;i--){
   if(this.type[i]==8){
     if(x>this.x1[i]&&x<this.x2[i]&&y>this.y1[i]&&y<this.y2[i]){
          this.nad=i;break;
          
     }
   }else
   if(this.type[i]==5){
     if(x>this.x1[i]&&x<this.x2[i]&&y>this.y1[i]&&y<this.y2[i]){
          this.nad=i;break;
          
     }
   }

 }

}


drawscrollbar=function (ci,c) {
    
    let wdx=this.dx[ci];
    let wdy=this.dy[ci];
    let wzm=this.zm[ci];
                    c.scale(wzm,wzm)
                    c.translate(wdx,wdy);
let i=ci;
do{
 i++;

 if (this.type[i] == 3) { //BITMAP
                    //if(cy1>0-hh&&cy2<h+hh&&cx1>0-(ww)&&cx2<w+ww){
                    if (this.bit[i]!=-1) {
                        if (this.bitmaps[this.bit[i]] != null&&this.bitmaps[this.bit[i]].width>0) {
                            var bw = this.bitmaps[this.bit[i]].width;
                            var bh = this.bitmaps[this.bit[i]].height;
                         c.drawImage(this.bitmaps[this.bit[i]], 0, 0, bw, bh, this.x1[i], this.y1[i], this.x2[i]-this.x1[i], this.y2[i]-this.y1[i]);
                            //c.drawImage(this.bitmaps[this.bit[i]],this.x1[i], this.y1[i]);

                        }}

                }


                if (this.type[i] == 12) {//FRAME
                    c.strokeStyle=this.col[i];
                 
                   c.beginPath()
                    c.rect(this.x1[i], this.y1[i],this.x2[i]-this.x1[i],this.y2[i]-this.y1[i]);
                     c.stroke();
                }
if (this.type[i] == 13) {//line width

//c.fillStyle=this.col[i];
c.lineWidth=this.x2[i];

 
}

                if (this.type[i] == 4) {//TEXT

                    if (this.str[i]!=undefined) {
                        // c.drawImage(this.bitmaps[this.bit[i]], 0, 0, bw, bh, this.x1[i], this.y1[i], this.x2[i], this.y2[i]);
                        c.font=this.fsize[i]+"px '"+this.font[i]+"'";
                     
                        c.fillStyle="rgb(255,0,0)";
                        //c.fillText(this.str[i],this.x1[i], this.y1[i],this.x2[i]-this.x1[i]);
                       

                        //this.textrect(c,this.str[i],this.fsize[i],this.x1[i], this.y1[i],this.x2[i],this.y2[i]);
                        c.beginPath()
                        c.rect(this.x1[i], this.y1[i],this.x2[i],this.y2[i]);
                        c.stroke();}
                    /*c.font="48px font0";
                    c.fillStyle="rgb(255,0,0)";
                  c.fillText("Demo",10,10)*/
                }

                if (this.type[i] == 6) { //ANIM BITMAP
                    //if(cy1>0-hh&&cy2<h+hh&&cx1>0-(ww)&&cx2<w+ww){
                    if (this.bit[i]!=-1) {
                        if (this.bitmaps[this.bit[i]] != undefined&&this.bitmaps[this.bit[i]].width>0) {


                            var bw = this.bitmaps[this.bit[i]].width;
                            var bh = this.bitmaps[this.bit[i]].height;



                            //  c.drawImage(this.bitmaps[this.bit[i]], 0, 0, bw, bh, this.x1[i], this.y1[i], this.x2[i]-this.x1[i], this.y2[i]-this.y1[i]);



                            // c.drawImage(this.bitmaps[this.bit[i]], 0, 0, bw, bh, this.x1[i], this.y1[i], this.x2[i], this.y2[i]);
                            //c.drawImage(this.bitmaps[this.bit[i]],this.x1[i], this.y1[i]);
                            //c.drawImage(this.bitmaps[this.bit[i]],this.x1[i], this.y1[i]);
                            var vy=Math.trunc((this.k[i]*this.sx[i])/bw);
                            var srx1=(this.k[i]-(this.dx[i]*vy))*this.sx[i];
                            var sry1=vy*this.sy[i];
                            var srx2=(this.k[i]-(this.dx[i]*vy)+1)*this.sx[i];
                            var sry2=(vy+1)*this.sy[i];
                            //  this.alert1="sx="+this.sx[i]+"sy="+this.sy[i]+"srx1="+srx1+"sry1="+sry1+"srx2="+srx2+"sry2="+sry2

                            //c.drawImage(this.bitmaps[this.bit[i]],srx1,sry1,srx2-srx1,sry2-sry1,this.x1[i], this.y1[i],this.x2[i]-this.x1[i], this.y2[i]-this.y1[i]);
                            // c.fillRect(this.x1[i], this.y1[i], this.x2[i]-this.x1[i], this.y2[i]-this.y1[i])
                         var prc=1.0
                            if(this.an[i]>0){
                            prc=(an[i]/(performance.now()-this.an1[i]));
                             if(prc<0.001)this.an[i]=0;
                            }
                            c.drawImage(this.bitmaps[this.bit[i]],srx1,sry1,srx2-srx1,sry2-sry1,this.x1[i], this.y1[i],(this.x2[i]-this.x1[i])*prc, this.y2[i]-this.y1[i]);



                        }}

                }


}while(i<512&&this.type[i]!=8&&this.type[i]!=5)




}




cropcanvastobase64=function (ci) {
    let tcanvas = document.createElement("canvas");
    tcanvas.width=this.x2[ci]-this.x1[ci];
    tcanvas.height=this.y2[ci]-this.y1[ci];
    let c = tcanvas.getContext("2d"); 

    this.drawscrollbar(ci,c)
    
    var dataURL = tcanvas.toDataURL();
   



return dataURL;

}



lastx=0
lasty=0
        constructor(canvas) {
            this.ctx=canvas.getContext('2d');

            var canvas = document.getElementById("canvasOne");
canvas.width  = window.innerHeight*0.55;
canvas.height =window.innerHeight;
//canvas.setAttribute('style', "position: absolute; top: 0px; left: 0px; right: 0px; bottom: 0px; margin: auto; border:2px solid blue");
            this.w=canvas.width;
            this.h=canvas.height;
            this.tcanvas = document.createElement("canvas");
            
            
this.addfont("font0.ttf", "url('res/font0.woff')");
this.addfont("font1.ttf", "url('res/font1.woff')");
this.addfont("font2.ttf", "url('res/font2.woff')");
this.addfont("font3.ttf", "url('res/font3.woff')");
this.addfont("font4.ttf", "url('res/font4.woff')");
this.addfont("font5.ttf", "url('res/font5.woff')");
this.addfont("font6.ttf", "url('res/font6.woff')");
this.addfont("font7.ttf", "url('res/font7.woff')");


//TOUCH
canvas.addEventListener('touchstart',  (e)=>  {

if (e.touches.length === 2) {

    e.preventDefault(); // Prevent page scroll
//console.log("st2")



    // Calculate where the fingers have started on the X and Y axis
    this.pinchx = (e.touches[0].pageX + e.touches[1].pageX) / 2;
    this.pinchy = (e.touches[0].pageY + e.touches[1].pageY) / 2;
    this.pinchd = this.distance(e);
for (var i = 1; i < this.count; i++) {
        if(this.type[i]==8) {
            var jmx=e.touches[0].pageX
            var jmy=e.touches[0].pageY

            if(jmx>this.x1[i]&&jmy>this.y1[i]&&jmx<this.x2[i]&&jmy<this.y2[i]) {
                this.szm=this.zm[i];
            }


        }
    }
    
    
    
    
}else{

    e.preventDefault();
//console.log("st1
this.lastx=e.touches[0].pageX
this.lasty=e.touches[0].pageY

//console.log("t0="+e.touches[0].pageX+" t1="+e.touches[0].pageX);

    this.mousedownevent(e.touches[0].pageX,e.touches[0].pageY);

  /* var cx = e.touches[0].pageX
    var cy = e.touches[0].pageY
     this.stox=cx;this.stoy=cy;
    this.key=1;
    for (var i = 0; i < this.count; i++) {
        if (this.type[i] == 8) {if (cx > this.x1[i] && cy > this.y1[i] && cx < this.x2[i]&& cy < this.y2[i]) {
            this.pressed=i;
            this.key=1;
            this.mx1[i]=cx-this.dx[i];
            this.my1[i]=cy-this.dy[i];
            for (var j = this.count; j >i ; j--) {
                if (cx-this.dx[i] > this.x1[j] && cy-this.dy[i] > this.y1[j] && cx-this.dx[i] < this.x2[j] && cy-this.dy[i] < this.y2[j]) {
                    this.mousetop=j;

                    break;
                }
            }
            for (var j = this.mousetop-1; j >0 ; j--) {
                if (cx-this.dx[i] > this.x1[j] && cy-this.dy[i] > this.y1[j] && cx-this.dx[i] < this.x2[j] && cy-this.dy[i] < this.y2[j]) {
                    this.mstate[j]=1;
                    this.alert1="mstate1 "+j+" ";
                    break;
                }
            }


        }}

    }*/
}

}, false);


canvas.addEventListener('touchmove',  (e)=>  {
//console.log("mv "+e.touches.length);
if (e.touches.length == 2) {

    var dis=this.distance(e)
    var scale =dis/ this.pinchd;
    // alert(this.distance(e)+" "+this.pinchd);

    for (var i = 1; i < this.count; i++) {
        if(this.type[i]==8) {
            var jmx=e.touches[0].pageX
            var jmy=e.touches[0].pageY
this.lastx=e.touches[0].pageX
this.lasty=e.touches[0].pageY
            if(jmx>this.x1[i]&&jmy>this.y1[i]&&jmx<this.x2[i]&&jmy<this.y2[i]) {
                this.mstate[i]=6;
                this.mweel[i]=this.szm*scale;
//console.log("mv 2 "+scale);
            }


        }
    }



}else{

    e.preventDefault();
  //  console.log("t0="+e.touches[0].pageX);
    this.mousemoveevent(e,e.touches[0].pageX,e.touches[0].pageY);



     this.lastx=e.touches[0].pageX
this.lasty=e.touches[0].pageY
    //alert("stx"+this.stox+" cx"+e.touches[0].pageX)
 /*   var mx=e.touches[0].pageX
    var my=e.touches[0].pageY

    var cx = mx-this.stox;
    var cy = my-this.stoy;



    this.stox=cx;this.stoy=cy;

    this.key=2;
    for (var i = 1; i < this.count; i++) {
        if(this.type[i]==8) {
            if(mx>this.x1[i]&&my>this.y1[i]&&mx<this.x2[i]&&my<this.y2[i]) {
                this.wover = i;
                this.mvx[i] = 0;this.mvy[i]= 0;
                if (this.pressed==i) {
                    this.mvx[i] = cx;
                    this.mvy[i]= cy;

                    this.mx1[i]=mx;
                    this.my1[i]=my;
                    // alert(this.pressed+" "+this.mvx[i]+" "+ this.mvy[i]);
                }


            }


        }
    }*/
}
}, false);

canvas.addEventListener('touchend',  (e)=>  {
    
e.preventDefault();

this.mouseupevent(this.lastx,this.lasty);

// alert("end")

}, false);

canvas.addEventListener('mouseleave', (e)=> {
e.preventDefault();
this.mouseupevent(e.clientX,e.clientY);

}, false);


canvas.addEventListener('mousemove', (e)=> {
e.preventDefault();
this.mousemoveevent(e,e.clientX,e.clientY);

}, false);
canvas.addEventListener('mousedown', (e)=>  {
e.preventDefault();
this.key=1;
this.mousedownevent(e.clientX,e.clientY);

}, false);
canvas.addEventListener('mouseup', (e)=>  {

e.preventDefault();

this.mouseupevent(e.clientX,e.clientY);



}, false);


canvas.addEventListener('mouseleave', (e)=>  {
e.preventDefault();
this.key=0;
this.pressedw=0;
}, false);


canvas.addEventListener('drop',  (e)=>  {
e.preventDefault();
alert(e.dataTransfer.files[0]);
}, false);
canvas.addEventListener('mousewheel',  (e)=>  {
e.preventDefault();
for (var i = 1; i < this.count; i++) {
    if (this.type[i] == 8) {
        if (e.clientX > this.x1[i] && e.clientY > this.y1[i] && e.clientX < this.x2[i] && e.clientY < this.y2[i]) {
            this.wover = i;
          
            if (this.wover == i) {
                this.mstate[i] = 5;
                this.mweel[i] = e.deltaY;
               // console.log("zoom"+this.mweel[i]);
            }

        }


    }
}
}, false);
            this.bitmaps=new Array()

            for (var i = 0; i < 512; i++) {

                this.refresh[i] = 2;
                this.type[i]=-1;
                this.bit[i]=-1;

                this.sdx[i] = 1;
                this.sdy[i] = 1;
                this.dx[i] = 1;
                this.dy[i] = 1;
                this.sx[i] = 1;
                this.sy[i] = 1;

                this.x1[i] = 1;
                this.y1[i] = 1;
                this.x2[i] = 1;
                this.y2[i] = 1;

              

                this.zm[i] = 1.0;



                this.an[i] = 0;
                this.n[i] = 0;
                this.an1[i] = 0;

                this.rot[i] = 0;

                this.k[i] = 0;
                this.id[i] = 0;

                this.refresh[i] = 2;
  
                
                this.value[i] = 0;
                this.mstate[i] = 0;
            }
            this.pindex = 0;




        }


        findb(path) {
            let index = 0;
            for (let i = 1; i < 512; i++) {
                if (this.paths[i] == undefined){

                    this.loading=true;
                    index = i;

                 this.paths[i] = path;
                  break;
                
                }
                if (path == this.paths[i]) {
                    //
                    index = i;

                    this.paths[i] = path;
                    break;
                }
            }
            return index;
        }

        deletebit(ind){
            this.bitmaps[ind]=undefined;
            this.paths[ind] = undefined;
           
        }




        changebounds(x1, y1, x2, y2) {
            if (x1 < this.fx1)this.fx1 = x1;
            if (y1 < this.fy1)this.fy1 = y1;
            if (x2 > this.fx2)this.fx2 = x2;
            if (y2 > this.fy2)this.fy2 = y2;
            if (this.fx2 > this.sx[this.wci]) this.sx[this.wci] = this.fx2;
            if (this.fy2 > this.sy[this.wci]) this.sy[this.wci] = this.fy2;
        }

        start() {
            this.pindex = 0;if(this.waitstart){
let i=1;
            do{
                //if(this.type[i]==-1)break;
                this.mstate[i]=0;
                this.refresh[i]=1;
                i++;
            }while(i<this.count)
                
                this.waitstart=false;}
            for (var i = 0; i < 64; i++) {
                this.id[i] = 0;
            }
            
        }
        waitstart() {
            this.pindex=0;
          //  this.waitstart=true;
          if(waitstart){refreshall();waitstart=false;}
        }

        copyprt(ind) {
            //sprt[63].refresh=prt[ind].refresh;

            this.bit1[63] = this.bit[ind];
            this.dx1[63] = this.dx[ind];
            this.dy1[63] = this.dy[ind];
            this.sx1[63] = this.sx[ind];
            this.sy1[63] = this.sy[ind];

            this.x11[63] = this.x1[ind];
            this.y11[63] = this.y1[ind];
            this.x21[63] = this.x2[ind];
            this.y21[63] = this.y2[ind];

            this.stx1[63] = this.stx[ind];
            this.sty1[63] = this.sty[ind];

            this.zm1[63] = this.zm[ind];

            this.k1[63] = this.k[ind];
            this.id1[63] = this.id[ind];

        }
        pasteprt(ind) {
            this.refresh[ind] = 1; //obnovit

            this.bit[ind] = this.bit1[63];
            this.dx[ind] = this.dx1[63];
            this.dy[ind] = this.dy1[63];
            this.sx[ind] = this.sx1[63];
            this.sy[ind] = this.sy1[63];

            this.x1[ind] = this.x11[63];
            this.y1[ind] = this.y11[63];
            this.x2[ind] = this.x21[63];
            this.y2[ind] = this.y21[63];

            this.stx[ind] = this.stx1[63];
            this.sty[ind] = this.sty1[63];

            this.zm[ind] = this.zm1[63];

            this.k[ind] = this.k1[63];
            this.id[ind] = this.id1[63];

        }

        resetform() {
            this.pindex = 0;
            this.fx1 = 1000; this.fy1 = 1000; this.fx2 = 1; this.fy2 = 1;

            this.scry = 0; this.sty = 0;
            this.count = 0;
            for (var i = 0; i < 512; i++) {

                this.refresh[i] = 2;

                this.bit[i]=-1;
                this.dx[i] = 1;
                this.dy[i] = 1;
                this.sx[i] = 1;
                this.sy[i] = 1;

                this.x1[i] = 1;
                this.y1[i] = 1;
                this.x2[i] = 1;
                this.y2[i] = 1;

                this.stx[i] = 1;
                this.sty[i] = 1;

                this.zm[i] = 1;
                this.an[i] = 0;
                this.n[i] = 0;
                this.an1[i] = 0;

                this.rot[i] = 0;

                this.k[i] = 0;
                this.id[i] = 0;

                this.refresh[i] = 2;

                this.mstate[i] = 0;

            }
            for (var i = 1; i <= 127; i++) {
                this.refresh[i] = 1;
            }
        }



        setmain(i) {
            //if(prt[ind].refresh){
            this.pi = this.pindex;
            this.ex1 = this.x1[this.pindex];
            this.ey1 = this.y1[this.pindex];
            this.ex2 = this.x2[this.pindex];
            this.ey2 = this.y2[this.pindex];



            //}
        }
        setid(i) {
           // if(this.refresh[this.pindex] > 0)return;
         // console.log("set "+i+" to "+this.pindex)
         ///   this.id[this.pindex] = i;
            this.id[i] = this.pindex;
            this.epi = this.pindex;//i;
            if(this.refresh[this.pindex]>1)this.epi = -1;
            this.ex1 = this.x1[this.pindex];
            this.ey1 = this.y1[this.pindex];
            this.ex2 = this.x2[this.pindex];
            this.ey2 = this.y2[this.pindex];
        }
        getid(i) {
           // if(this.epi>0)return;
            //console.log("get "+this.pindex)
//console.log("get "+i+" value "+this.id[i])
    
         
            this.epi = this.id[i];

         
            this.ex1 = this.x1[this.epi];
            this.ey1 = this.y1[this.epi];
            this.ex2 = this.x2[this.epi];
            this.ey2 = this.y2[this.epi];

        }

        loadbit(path) {
            let temp;
            temp = new Image();
            temp.src = path;
            temp.onload = function () {};
            return temp
        }


       

addfont=(name,url)=>{

   let f = new FontFace(name,url, {});
   //this.loading=true;
   try {
   // console.log()
 
   f.load().then(function (loadedFace) {
  document.fonts.add(loadedFace);
 // console.log(loadedFace)
 // this.loading=false;
});  
} catch (error) {
    console.log(error)
   }


//do{}while(this.loading);

}



        loadfont(path) {
            if(this.loading)return;
            let index = 0;
            for (let i = 1; i < 512; i++) {
                if ((path == this.fpaths[i]) || (this.fpaths[i] == undefined)) {           
                
                        index = i;
                       this.addfont(path, "url('"+path+"')");
                           
                    this.fpaths[i] = path; break;
                }
            }
            return index;
        }




      









        refreshall() {
            let i=1;
            do{
               // this.mstate[i]=0;
                this.refresh[i]=1;
                i++;
            }while(i<this.count)
           // this.pindex=0;
             this.waitstart=true;
      //   if(this.key==2) this.key=0
          
          
          
        }
        refreshfull() {
            let i=1;
            do{
                //if(this.type[i]==-1)break;
                this.mstate[i]=0;
                this.refresh[i]=2;
                i++;
            }while(i<this.count)
          //  this.waitstart=true;
           // this.pindex=0;
        }



        resizeImage(imgToResize,w,h) {
            const canvas = document.createElement("canvas");
            const context = canvas.getContext("2d");

            canvas.width = w;
            canvas.height = h;

            context.drawImage(
                imgToResize,
                0,
                0,
                w,
                h
            );

            return canvas.toDataURL();
        }




lindex=9999;

        addscrollbar=function(x1,y1,x2,y2,c){

         
       //     if(this.waitstart)return;
           
        
                this.pindex++;
this.type[this.pindex]=8;
             
                this.wci=this.pindex;
                this.wcx1=x1;this.cy1=y1;this.wcx2=x2;this.wcy2=y2;

                this.fx1=0;this.fy1=0;this.fx2=1;this.fy2=1;
            
         //   if(this.refresh[this.pindex]>0){
             
              
                this.x1[this.pindex]=x1;
                
                this.y1[this.pindex]=y1;
                this.x2[this.pindex]=x2;
                this.y2[this.pindex]=y2;
                
             //  console.log("scroll "+x1+" "+y1+" "+x2+" "+y2)
                
                
                if(this.refresh[this.pindex]==2){
                    this.sx[this.pindex]=0;
                    this.sy[this.pindex]=0;
                    this.dx[this.pindex]=0;
                    this.dy[this.pindex]=0;
                    this.zm[this.pindex]=1.0;
                }
                
                this.mrk[this.pindex]=this.marki;
                this.col[this.pindex]=c;
                if(this.refresh[this.pindex]==2){this.chd[this.pindex]=true;this.refresh[this.pindex]=0;}

                if(this.x1[this.pindex]>1.0&&this.x2[this.pindex]>1.0) this.refresh[this.pindex]=0;
                if(this.pindex>this.count)this.count=this.pindex;
              
              // this.id[this.pindex]=-1;
          
          //  }

        }

        addoverlay=function(x1,y1,x2,y2,c){
         //   if(this.waitstart)return;
            //Log.e("M","svrollbar");
         
                this.pindex++;
this.type[this.pindex]=5;
                this.wci=this.pindex;
                this.wcx1=x1;this.cy1=y1;this.wcx2=x2;this.wcy2=y2;

                this.fx1=0;this.fy1=0;this.fx2=1;this.fy2=1;
            
           if(this.refresh[this.pindex]>0){
              //  console.log("addover()"+this.pindex);
           
                this.x1[this.pindex]=x1;
                this.y1[this.pindex]=y1;
                this.x2[this.pindex]=x2;
                this.y2[this.pindex]=y2;
               
                
                this.mrk[this.pindex]=this.marki;
               
                if(this.refresh[this.pindex]==2){this.chd[this.pindex]=true;this.refresh[this.pindex]=0;}
                if(this.x1[this.pindex]>1.0&&this.x2[this.pindex]>1.0) this.refresh[this.pindex]=0;
                if(this.pindex>this.count)this.count=this.pindex;
           
               // this.id[this.pindex]=-1;
           }

        }







        copytocb=function(text){
            navigator.clipboard.writeText(text);
        }




 


 loadbitmap(file) {
     //if(this.loading||this.waitstart)return;
    let bitid=this.findb(file);
    //this.loading=true;
     this.bitmaps[bitid] = new Image();
     this.bitmaps[bitid].src ="res/"+file.replace("-","")
     this.bitmaps[bitid].onload = function () {
      //  this.loading=false;


            };
    
}

addloadedanimbitmap=function(file,dx,dy,k,x1,y1,x2,y2){
        
            this.pindex++;

                let i=this.pindex;
                this.mrk[i]=this.marki;
                this.type[this.pindex]=6;

                let bitid=this.findb(file);
                   if(this.bitmaps[bitid]==undefined){alert(file+" undefined");exit;}
                        if (y2 == x2 && x2 == 999999999) {
                            x2 = x1+this.bitmaps[bitid].width
                            y2 = y1+this.bitmaps[bitid].height

                        } else {
                            if (x2 == 999999999)x2 = (x1+((this.bitmaps[bitid].width/dx)/((this.bitmaps[bitid].height/dy)/(y2-y1))));
                            if (y2 == 999999999)y2 = (y1+((this.bitmaps[bitid].height/dy)/((this.bitmaps[bitid].width/dx)/(x2-x1))));
                        }

                            this.bit[this.pindex] = bitid;
                            this.x1[this.pindex] = x1;
                            this.y1[this.pindex] = y1;
                            this.x2[this.pindex] = x2;
                            this.y2[this.pindex] = y2;
                            this.sx[this.pindex]=this.bitmaps[bitid].width/dx;
                            this.sy[this.pindex]=this.bitmaps[bitid].height/dy;
                          //  this.id[this.pindex] = -1;
/*
                            if (this.refresh[this.pindex] == 2) {
                                this.chd[this.pindex] = true;

                                this.refresh[this.pindex] = 0;

                            }

                            this.changebounds(x1, y1, x2, y2);
                           
                            if (x1 > 1.0 || x2 > 1.0){this.refresh[this.pindex] = 0; }
                            if (this.pindex > this.count) this.count = this.pindex;
                            this.loading=false
                            return;*/
                        

        }

        updatebitmaps=function(){
            let ln=0;
			for(let i=0;i<512;i++){
			      if(this.bitmaps[i]==undefined&&this.paths[i]!=undefined){
                   // alert(i+" "+this.paths[i]);  
                  // console.log("add to loads "+this.paths[i]);
                    ln++;
			        this.loading=true;
                    this.bitmaps[i] = new Image();
                    if(this.paths[i].indexOf("data:image")>-1)  this.bitmaps[i].src=this.paths[i]; else{

                      if(this.paths[i].indexOf("http:")==-1) { this.bitmaps[i].src="res/"+this.paths[i].replace("-",""); }else {this.bitmaps[i].src=this.paths[i];}
                    }
                    this.bitmaps[i].onload=()=>{

                      
					}
		          }
		
           }
           if(ln==0&&this.loading){
             
           
              this.refreshall()
              this.loading=false
        
           }

        }


        addanimbitmap=function(file,dx,dy,k,x1,y1,x2,y2){
         //   if(this.waitstart)return;
            this.pindex++;
this.type[this.pindex]=6;
            if (this.refresh[this.pindex] > 0) {
//console.log("addanim()"+this.pindex);
                let i=this.pindex;
                
               
                let bitid=this.findb(file);
                this.bit[this.pindex]=bitid;


                if(this.bitmaps[bitid]!=undefined){
                if(this.bitmaps[bitid].width>0){

                    
                    if (y2 == x2 && x2 == 999999999) {
                        x2 = x1 + this.bitmaps[bitid].width
                        y2 = y1 + this.bitmaps[bitid].height

                    } else {
                        if (x2 == 999999999) x2 = (x1 + ((this.bitmaps[bitid].width / dx) / ((this.bitmaps[bitid].height / dy) / (y2 - y1))));
                        if (y2 == 999999999) y2 = (y1 + ((this.bitmaps[bitid].height / dy) / ((this.bitmaps[bitid].width / dx) / (x2 - x1))));
                    }
 
                    this.sx[this.pindex]=this.bitmaps[bitid].width/dx;
                    this.sy[this.pindex]=this.bitmaps[bitid].height/dy;

                    


                    
                    this.dx[this.pindex] = dx;
                    this.dy[this.pindex] = dx;
                    this.k[this.pindex]=k;

                        



                    this.x1[this.pindex] = x1;
                    this.y1[this.pindex] = y1;
                    this.x2[this.pindex] = x2;
                    this.y2[this.pindex] = y2; 
                   this.changebounds(x1, y1, this.x2[this.pindex], this.y2[this.pindex]);
                   this.refresh[this.pindex] = 0;this.chd[this.pindex] = true;
                    if (this.pindex > this.count)this.count = this.pindex;
                }
              }

                
                if(this.bitmaps[bitid]==undefined){this.refresh[this.pindex]=3;}//net bitmapa loading start
                if(this.refresh[this.pindex]==3&&this.bitmaps[bitid]!=undefined){//loaded bitmap
                    if(this.bitmaps[bitid].width>0){
                    if (y2 == x2 && x2 == 999999999) {
                        x2 = x1 + this.bitmaps[bitid].width
                        y2 = y1 + this.bitmaps[bitid].height

                    } else {
                        if (x2 == 999999999) x2 = (x1 + ((this.bitmaps[bitid].width / dx) / ((this.bitmaps[bitid].height / dy) / (y2 - y1))));
                        if (y2 == 999999999) y2 = (y1 + ((this.bitmaps[bitid].height / dy) / ((this.bitmaps[bitid].width / dx) / (x2 - x1))));
                    }

                    //alert(this.paths[bitid]+" loaded")
                    this.sx[this.pindex]=this.bitmaps[bitid].width/dx;
                    this.sy[this.pindex]=this.bitmaps[bitid].height/dy;

                    


                    this.dx[this.pindex] = dx;
                    this.dy[this.pindex] = dx;
                    this.k[this.pindex]=k;

                    this.x1[this.pindex] = x1;
                    this.y1[this.pindex] = y1;
                    this.x2[this.pindex] = x2;
                    this.y2[this.pindex] = y2; 
                   this.changebounds(x1, y1, this.x2[this.pindex], this.y2[this.pindex]);
                   if (this.refresh[this.pindex]==2){this.chd[this.pindex] = true;this.refresh[this.pindex] = 0;}
                    if (this.pindex > this.count)this.count = this.pindex;
                    this.refresh[this.pindex]=0;
                   }
                } 
                    
                 

            }
        
        }






        loading =false;

        addwbitmap=function(file, x1, y1, x2, y2) {
   //    if(this.waitstart)return; 
            
            this.pindex++;
this.type[this.pindex] = 3;

            if (this.refresh[this.pindex] > 0) {

                var bitid = this.findb(file);
               
            
                
                            this.bit[this.pindex] = bitid;
                            this.x1[this.pindex] = x1;
                            this.y1[this.pindex] = y1;
                          //  this.id[this.pindex] = -1;

              if(this.bitmaps[bitid]!=undefined){//bitmap uzhe zagruzhen prosto obn
                if(this.bitmaps[bitid].width>0){
                if (y2 == x2 && x2 == 999999999) {
                        x2 = x1+this.bitmaps[bitid].width;
                        y2 = y1+this.bitmaps[bitid].height;
                    } else {
                        if (x2 == 999999999)x2 = (x1+((this.bitmaps[bitid].width)/((this.bitmaps[bitid].height)/(y2-y1))));
                        if (y2 == 999999999)y2 = (y1+((this.bitmaps[bitid].height)/((this.bitmaps[bitid].width)/(x2-x1))));
                    }

                    
                            this.x2[this.pindex] = x2;
                            this.y2[this.pindex] = y2;
                           // this.loading=false;
                          //  alert("loaded"+this.paths[bitid]+" "+x1+" "+y1+" "+this.x2[this.pindex]+" "+this.y2[this.pindex]);
                   this.changebounds(x1, y1, this.x2[this.pindex], this.y2[this.pindex]);
                   if (this.refresh[this.pindex]==2){this.chd[this.pindex] = true;this.refresh[this.pindex] = 0;}
                    if (this.pindex > this.count)this.count = this.pindex;this.refresh[this.pindex]=0; 
                }
              }



              if(this.bitmaps[bitid]==undefined){this.refresh[this.pindex]=3;}//net bitmapa loading start
                if(this.refresh[this.pindex]==3&&this.bitmaps[bitid]!=undefined){//loaded bitmap
                 
                    if(this.bitmaps[bitid].width>0){
                    if (y2 == x2 && x2 == 999999999) {
                        x2 = x1+this.bitmaps[bitid].width;
                        y2 = y1+this.bitmaps[bitid].height;
                    } else {
                        if (x2 == 999999999)x2 = (x1+((this.bitmaps[bitid].width)/((this.bitmaps[bitid].height)/(y2-y1))));
                        if (y2 == 999999999)y2 = (y1+((this.bitmaps[bitid].height)/((this.bitmaps[bitid].width)/(x2-x1))));
                    }
                     
                            this.x2[this.pindex] = x2;
                            this.y2[this.pindex] = y2;
                           // this.loading=false;
                          //  alert("loaded"+this.paths[bitid]+" "+x1+" "+y1+" "+this.x2[this.pindex]+" "+this.y2[this.pindex]);
                   this.changebounds(x1, y1, this.x2[this.pindex], this.y2[this.pindex]);
                  this.refresh[this.pindex] = 0;this.chd[this.pindex] = true;
                    if (this.pindex > this.count)this.count = this.pindex;
                   }
               }
               
                           
                 

            }
        }









        addbitmap=function(file, x1, y1) {
        //    if(this.waitstart)return;

            this.pindex++;
this.type[this.pindex] = 3;

            if (this.refresh[this.pindex]>0) {
                var bitid = this.findb(file);
               
                
                    this.bit[this.pindex] = bitid;
                    this.x1[this.pindex] = x1;
                    this.y1[this.pindex] = y1;
                    this.x2[this.pindex] = x1+30;
                    this.y2[this.pindex] = y1+30;

                  //  this.id[this.pindex]=-1;


                    if(this.bitmaps[bitid]!=undefined){
                if(this.bitmaps[bitid].width>0){
              
                            this.x2[this.pindex] = x1+this.bitmaps[bitid].width;
                            this.y2[this.pindex] = y1+this.bitmaps[bitid].height;
                           // this.loading=false;
                          //  alert("loaded"+this.paths[bitid]+" "+x1+" "+y1+" "+this.x2[this.pindex]+" "+this.y2[this.pindex]);
                   this.changebounds(x1, y1, this.x2[this.pindex], this.y2[this.pindex]);
                   if (this.refresh[this.pindex]==2){this.chd[this.pindex] = true;this.refresh[this.pindex] = 0;}
                    if (this.pindex > this.count)this.count = this.pindex;this.refresh[this.pindex] = 0
                }
              }


                if(this.bitmaps[bitid]==undefined){this.refresh[this.pindex]=3; }
                if(this.refresh[this.pindex]==3&&this.bitmaps[bitid]!=undefined){
                   
                    this.x2[this.pindex] = x1+this.bitmaps[bitid].width;
                    this.y2[this.pindex] = y1+this.bitmaps[bitid].height;
                    this.changebounds(x1, y1, this.x2[this.pindex], this.y2[this.pindex]);
                     this.chd[this.pindex] = true;
                    if (this.pindex > this.count)this.count = this.pindex;this.refresh[this.pindex] = 0;

                }
                    
            }
        }
	


        textrect=function(context, text,size, x1, y1, x2, y2) {
            context.fillStyle="rgb(0,255,0)";
            context.rect(x1, y1, x2-x1, y2-y1)
            var words = text.split(' ');
            var line = '';
            var m = context.measureText(testLine);
            var t=m.actualBoundingBoxAscent + m.actualBoundingBoxDescent;
        
            var lineHeight=t;
            
            var maxWidth=x2-x1;
            y1+=size;


            for(var n = 0; n < words.length; n++) {
                var testLine = line + words[n] + ' ';
                var metrics = context.measureText(testLine);
                var testWidth = metrics.width;


                if (testWidth >=maxWidth && n > 0) {
                    let alignx=(maxWidth-context.measureText(line).width)/2;
                    /*if(testWidth >maxWidth){
                        let poi=testLine.length*(maxWidth/testWidth);
                        line=testLine.substring(0,poi)
                        testLine=testLine.substring(poi,testLine.length)

                    }*/


                    context.fillText(line, x1+alignx, y1);
                    line = /*testLine+*/words[n] + ' ';
                    y1 += lineHeight;
                }
                else {
                    line = testLine;
                }
            }
            let aligns=(maxWidth-context.measureText(line).width)/2;
            context.fillText(line, x1+aligns, y1);


            //
        }
        fittext1=function(context, text, x1, y1, x2, y2) {
            var bestsize=2;
            var words = text.split(' ');
            var line = '';
            for(let i=100;i>3;i--) {
                for (var n = 0; n < words.length; n++) {
                    var y=y1;
                    var fontArgs = context.font.split(' ');
                    var newSize = i+'px';
                    context.font = newSize + ' ' + fontArgs[fontArgs.length - 1];
                    var testLine = line + words[n] + ' ';
                    var metrics = context.measureText(testLine);
                    var testWidth = metrics.width;
                    if (testWidth > x2-x1 && n > 0) {
                        /* context.fillText(line, x, y);
                         line = words[n] + ' ';*/
                        y += i;
                    } else {
                        line = testLine;
                    }
                }
                if(y<y2-y1){bestsize=i;break;}
            }
            return bestsize;
        }


        fittext=function(context, text, x1, y1, x2, y2) {
            if(text==undefined)return 55;
            var bestsize=25;
            var wid=x2-x1;
            var words = text.split(' ');
            words.sort(function(a, b){
                return b.length - a.length;
            });
           //  alert(words[0]+" "+words[1]+" ");


            for(var size=160;size--;size>3) {
                var fontArgs = context.font.split(' ');
                var newSize = size+'px';
                context.font = newSize + ' ' + fontArgs[fontArgs.length - 1];
                if(context.measureText(words[0]).width<wid){bestsize=size;break;}

            }
            var m= context.measureText(text);
              var t= m.actualBoundingBoxAscent + m.actualBoundingBoxDescent;
            var vys=(y2-y1)-t*0.2

            for(var size=bestsize;size--;size>3)
            {
                var fontArgs = context.font.split(' ');
                var newSize = size+'px';
                context.font = newSize + ' ' + fontArgs[fontArgs.length - 1];
                var metrics = context.measureText(text);
              var tw= metrics.actualBoundingBoxAscent + metrics.actualBoundingBoxDescent;
                var kol=Math.round(metrics.width/wid)+1;

                if(kol*tw<vys) {
                    bestsize=size;
                    //console.log(kol+" "+bestsize+" vys "+vys)
                    break;
                }
            }
            
            return bestsize;
        }

        addwtext=function(str,font,size, x1, y1, x2, y2,color) {
            //this.loadfont(font)
         //   if(this.waitstart||this.loading)return;
            this.pindex++;
this.type[this.pindex] = 4;
            this.lindex=this.pindex
            if(this.refresh[this.pindex]>0) { 
              //  console.log("addwtwxt()"+this.pindex);
           
                let i = this.pindex;
                this.mrk[i] = this.marki;
                
                this.str[i] = str;
                if (font != "") this.font[i] = font;
                this.col[i] = color;

                if (size == 999999999) size = this.fittext(this.ctx, str, x1, y1, x2, y2);
                this.fsize[i] = size;//setTextSizeForWidth(tpaint,x2-x1,str);





                this.x1[i] = x1;
                this.y1[i] = y1;
                this.x2[i] = x2;
                this.y2[i] = y2;
              //  this.id[i] = -1;
                this.changebounds(Math.round(x1), Math.round(y1), Math.round(x2), Math.round(y2));
                
                if (this.epi!=-1) {this.chd[this.pindex]=true;this.refresh[i] = 0;}
                if(i>this.count)this.count=i;

            } else{
                let i = this.pindex;
                this.x1[i] = x1;
                this.y1[i] = y1;
                this.x2[i] = x2;
                this.y2[i] = y2;
             //   this.id[i] = -1;


            }

        }


        addwtext=function(str,font,size, x1, y1, x2, y2,color) {
            //this.loadfont(font)
            if(/*this.waitstart||*/this.loading)return;
            this.pindex++;
            this.type[this.pindex] = 4;
            this.lindex=this.pindex
            if(this.refresh[this.pindex]>0) { 
              //  console.log("addwtwxt()"+this.pindex);
           
                let i = this.pindex;
                this.mrk[i] = this.marki;
                
                this.str[i] = str;
                if (font != "") this.font[i] = font;
                this.col[i] = color;

                if (size == 999999999) size = this.fittext(this.ctx, str, x1, y1, x2, y2);
                this.fsize[i] = size;//setTextSizeForWidth(tpaint,x2-x1,str);

                this.x1[i] = x1;
                this.y1[i] = y1;
                this.x2[i] = x2;
                this.y2[i] = y2;
               // this.id[i] = -1;
                this.changebounds(Math.round(x1), Math.round(y1), Math.round(x2), Math.round(y2));
                
                //if (this.epi!=-1) {this.chd[this.pindex]=true;this.refresh[i] = 0;}
                if(i>this.count)this.count=i;

            } else{
                let i = this.pindex;
                this.x1[i] = x1;
                this.y1[i] = y1;
                this.x2[i] = x2;
                this.y2[i] = y2;
              //  this.id[i] = -1;


            }

        }

        addframe=function(x1, y1, x2, y2,color) {
          //  if(this.waitstart)return;
            this.pindex++;

           // if(this.refresh[this.pindex]>0) {
    //  console.log("addframe()"+this.pindex);          this.loading=true;
                let i = this.pindex;
                this.mrk[i] = this.marki;
                this.type[i] = 12;
                this.col[i] = color;

                this.x1[i] = x1;
                this.y1[i] = y1;
                this.x2[i] = x2;
                this.y2[i] = y2;
               // this.id[i] = -1;
                this.changebounds(Math.round(x1), Math.round(y1), Math.round(x2), Math.round(y2));
                if (this.refresh[i] == 2) {
                    this.chd[i] = true;
                    this.refresh[i] = 0;
                }
                if (x1 > 1.0 || y1 > 1.0){this.chd[i] = true; this.refresh[i] = 0;}
              
                if(i>this.count)this.count=i;
            //}

        }



        addline=function(x1, y1, x2, y2,color) {
        //    if(this.waitstart)return;
            this.pindex++;
           // if(this.refresh[this.pindex]>0) {
    //  console.log("addframe()"+this.pindex);          this.loading=true;
                let i = this.pindex;
                this.mrk[i] = this.marki;
                this.type[i] = 10;
                this.col[i] = color;

                this.x1[i] = x1;
                this.y1[i] = y1;
                this.x2[i] = x2;
                this.y2[i] = y2;
              //  this.id[i] = -1;
                this.changebounds(Math.round(x1), Math.round(y1), Math.round(x2), Math.round(y2));
                if (this.refresh[i] == 2) {
                    this.chd[i] = true;
                    this.refresh[i] = 0;
                }
                if (x1 > 1.0 || y1 > 1.0){this.chd[i] = true; this.refresh[i] = 0;}
              
                if(i>this.count)this.count=i;
            //}

        }

        
        setlinewidth=function(wdt) {
         //   if(this.waitstart)return;
            this.pindex++;
 
          //  if(this.refresh[this.pindex]>0) {
                       // console.log("setlinew()"+this.pindex);   this.loading=true;
                let i = this.pindex;
                this.mrk[i] = this.marki;
                this.type[i] = 13;
  
                this.x2[i] = wdt
              
               // this.id[i] = -1;
                 if (this.refresh[i] == 2) {
                    this.chd[i] = true;
                    this.refresh[i] = 0;
                }
                 this.refresh[i] = 0;
                if(i>this.count)this.count=i;
                
          //  }
        }





 operand=["t0","t1","t2","Bitmap","Text","Overlay","AnimBitm","t7","ScrollB","t9","Line","t11","Frame","LWidth","t14","t15","t16"];




        draw(can, c) {
            this.stx=this.x;this.sty=this.y;
           if(this.pindex!=0) this.count = this.pindex;


            if (this.first) {
                this.w = can.width; this.h = can.height; this.wd = this.w/5; this.first = false;
            }

            this. scx = 0; this.scy = 0;
            this. wx1 = 0; this.wy1 = 0; this.wx2 = this.w; this.wy2 = this.h; //sbros

            for (var i = 0; i <= this.count; i++) {

               

                if(this.type[i]==8){//scrollbox

                    if(this.scrfirst){this.scrfirst=false;	c.save();}c.fillStyle= "rgb(255,0,0)";
                    c.font="17px '"+this.font[i]+"'";
                   // c.fillText(1+"x"+1+" "+this.sx[this.wci]+"x"+this.sy[this.wci]+" ",60,60);
                    c.fillRect(this.sx[this.wci]-10,this.sy[this.wci]-10,10,10)
                   // c.rect(1,1,this.sx[this.wci],this.sy[this.wci])
                   // c.stroke();
                    this.wci=i;

                    this.wx1=this.x1[i];
                    this.wy1=this.y1[i];
                    this.wx2=this.x2[i];
                    this.wy2=this.y2[i];//sbros

                    c.restore();
                    c.save();
                    let region = new Path2D();
                    region.rect(this.wx1, this.wy1, this.wx2-this.wx1, this.wy2-this.wy1);
                    c.clip(region, "evenodd");
                  
                    c.fillStyle= this.col[i]
                    c.fillRect(this.wx1, this.wy1, this.wx2-this.wx1, this.wy2-this.wy1);
                    

                    this.wdx=this.dx[i];
                    this.wdy=this.dy[i];
                    this.wzm=this.zm[i];
c.translate(this.wx1,this.wy1);

                    c.scale(this.wzm,this.wzm)
                    c.translate(this.wdx,this.wdy);

                }


                if(this.type[i]==5){//overlay

                    if(this.scrfirst){this.scrfirst=false;	c.save();}
                    this.wci=i;

                    this.wx1=this.x1[i];
                    this.wy1=this.y1[i];
                    this.wx2=this.x2[i];
                    this.wy2=this.y2[i];//sbros


                    c.restore();
                    c.save();
                    let region = new Path2D();
                    region.rect(this.wx1, this.wy1, this.wx2-this.wx1, this.wy2-this.wy1);
                    c.clip(region, "evenodd");
                    c.fillStyle= this.col[i]
                    
                  //  c.fillRect(0,0,2000,2000);


                    this.wdx=0;
                    this.wdy=0;
                    this.wzm=1.0;
                    c.scale(this.wzm,this.wzm)
                    c.translate(this.wdx,this.wdy);

}




                if (this.type[i] == 3) { //BITMAP
                 
                    //if(cy1>0-hh&&cy2<h+hh&&cx1>0-(ww)&&cx2<w+ww){
                    if (this.bit[i]!=-1) {
                        if (this.bitmaps[this.bit[i]] != null&&this.bitmaps[this.bit[i]].width>0) {
                            var bw = this.bitmaps[this.bit[i]].width;
                            var bh = this.bitmaps[this.bit[i]].height;
                       
                    
                            c.drawImage(this.bitmaps[this.bit[i]], 0, 0, bw, bh, this.x1[i], this.y1[i], this.x2[i]-this.x1[i], this.y2[i]-this.y1[i]);
                         c.fillText(this.bit[i],this.x1[i]+ 70,  this.y1[i]+70);
                        
                         
                         //c.drawImage(this.bitmaps[this.bit[i]],this.x1[i], this.y1[i]);

                        }}

                }

    if (this.type[i] == 10) {//LINE
                    c.strokeStyle=this.col[i];
                 
                   c.beginPath()
c.moveTo(this.x1[i], this.y1[i]); 
c.lineTo(this.x2[i],this.y2[i]); 
           
                   
                   
                   
                    c.stroke();
                }
                if (this.type[i] == 12) {//FRAME
                    c.strokeStyle=this.col[i];
                 
                   c.beginPath()
                    c.rect(this.x1[i], this.y1[i],this.x2[i]-this.x1[i],this.y2[i]-this.y1[i]);
                     c.stroke();
                }
if (this.type[i] == 13) {//line width

//c.fillStyle=this.col[i];
c.lineWidth=this.x2[i];

 
}

if (this.type[i] == 4) {//TEXT

if (this.str[i]!=undefined) {
    // c.drawImage(this.bitmaps[this.bit[i]], 0, 0, bw, bh, this.x1[i], this.y1[i], this.x2[i], this.y2[i]);
    c.font=this.fsize[i]+"px '"+this.font[i]+"'";
 /*
    c.fillStyle="rgb(255,255,0)";
    c.strokeStyle="rgb(255,0,0)";
    c.strokeWidth=1;
      c.beginPath()
       c.rect(this.x1[i], this.y1[i],this.x2[i]-this.x1[i],this.y2[i]-this.y1[i]);
       c.stroke()*/
    if(this.an[i]==0){
        this.textrect(c,this.str[i],this.fsize[i],this.x1[i], this.y1[i],this.x2[i],this.y2[i]);
       


    }else{

        let prc=1.0
        if(this.an[i]>0){
        prc=((performance.now()-this.an1[i])/this.an[i]);
         if(prc>1)this.an[i]=0;
         this.alert1=this.an[i];
         c.save()
         if(this.n[i]==1){
           c.translate(this.x1[i], this.y1[i]);
           c.scale(prc,1);
           this.textrect(c,this.str[i],this.fsize[i],0,0,(this.x2[i]-this.x1[i]),this.y2[i]-this.y1[i]);
         }

         c.restore()



    }
    
    
}
}
}



                if (this.type[i] == 6) { //ANIM BITMAP
                    //if(cy1>0-hh&&cy2<h+hh&&cx1>0-(ww)&&cx2<w+ww){
                    if (this.bit[i]!=-1) {
                        if (this.bitmaps[this.bit[i]] != undefined&&this.bitmaps[this.bit[i]].width>0) {


                            var bw = this.bitmaps[this.bit[i]].width;
                            var bh = this.bitmaps[this.bit[i]].height;



                            //  c.drawImage(this.bitmaps[this.bit[i]], 0, 0, bw, bh, this.x1[i], this.y1[i], this.x2[i]-this.x1[i], this.y2[i]-this.y1[i]);



                            // c.drawImage(this.bitmaps[this.bit[i]], 0, 0, bw, bh, this.x1[i], this.y1[i], this.x2[i], this.y2[i]);
                            //c.drawImage(this.bitmaps[this.bit[i]],this.x1[i], this.y1[i]);
                            //c.drawImage(this.bitmaps[this.bit[i]],this.x1[i], this.y1[i]);
                            var vy=Math.trunc((this.k[i]*this.sx[i])/bw);
                            var srx1=(this.k[i]-(this.dx[i]*vy))*this.sx[i];
                            var sry1=vy*this.sy[i];
                            var srx2=(this.k[i]-(this.dx[i]*vy)+1)*this.sx[i];
                            var sry2=(vy+1)*this.sy[i];
                            //  this.alert1="sx="+this.sx[i]+"sy="+this.sy[i]+"srx1="+srx1+"sry1="+sry1+"srx2="+srx2+"sry2="+sry2

                            //c.drawImage(this.bitmaps[this.bit[i]],srx1,sry1,srx2-srx1,sry2-sry1,this.x1[i], this.y1[i],this.x2[i]-this.x1[i], this.y2[i]-this.y1[i]);
                            // c.fillRect(this.x1[i], this.y1[i], this.x2[i]-this.x1[i], this.y2[i]-this.y1[i])
                           
                          // alert(performance.now())
                          let prc=1.0
                            if(this.an[i]>0){
                            prc=((performance.now()-this.an1[i])/this.an[i]);
                             if(prc>1)this.an[i]=0;
                             this.alert1=this.an[i];
                            }
                          /*  c.fillStyle="rgb(255,255,0)";
    c.strokeStyle="rgb(0,255,0)";
    c.strokeWidth=1;
      c.beginPath()
       c.rect(this.x1[i], this.y1[i],this.x2[i]-this.x1[i],this.y2[i]-this.y1[i]);
       c.stroke()*/
                            c.drawImage(this.bitmaps[this.bit[i]],srx1,sry1,srx2-srx1,sry2-sry1,this.x1[i], this.y1[i],(this.x2[i]-this.x1[i])*prc, this.y2[i]-this.y1[i]);



                        }}

                }







            }
            c.restore();c.fillStyle="rgb(0,15,250)";c.font="12px 'font1.ttf'";
            
            
        /*    for (var i = 0; i <= this.clcount; i++) {
                let bp=this.paths[this.bit[i]];
               if(bp!=undefined) c.fillText("cl "+this.type[i]+" ="+this.cli[i]+" "+bp.substring(0,Math.min(10,bp.length)) , 52,2+50 *(i+1))
                        

            }
       /*     let dd=performance.now();
            let co=dd-(Math.floor(dd/1000)*1000);
            c.fillRect(co,100,5,400);*/
           // c.fillText("alert="+this.alert1, 200, 100)
            
 
            
/*  for (var i = 0; i <= 200; i++) {
    if(this.paths[i]!=undefined){
          let fff
          if(this.paths[i].length>50)fff=this.paths[i].substring(0,50); else fff=this.paths[i];
           c.fillText(i+" "+fff, 50, 25 * i)}
}*/
               let intv=20;    for (var i = 0; i <= this.count; i++) {
                        if(this.type[i]>0)    c.fillText("refresh "+this.refresh[i]+" img["+this.bit[i]+"] [" + i + "] " + this.operand[this.type[i]] + " " + this.x1[i] + " " + this.y1[i] + " " + this.x2[i] + " " + this.y2[i], intv,intv * (i+1))
                             if(i==this.pressedw)c.fillText("                                                                                                              PRESSED " + this.y2[i], intv, intv * (i+1))
                             if(this.mstate[i]==1)c.fillText("                                                                                                               DOWN " + this.y2[i], intv, intv * (i+1))
                             if(this.mstate[i]==2)c.fillText("                                                                                                               MOVE " + this.y2[i], intv, intv * (i+1))
                             if(this.mstate[i]==3)c.fillText("                                                                                                             DRAG " + this.y2[i], intv, intv * (i+1))

                              
                          //  c.restore();

                        }
 //if(this.bitmaps[this.bit[17]]!==undefined)c.drawImage(this.bitmaps[this.bit[17]], 100,100)



c.fillStyle="rgb(255,255,250)"

for (var i = 0; i <= this.count; i++) {
                        if(this.type[i]>0)    c.fillText("refresh "+this.refresh[i]+" img["+this.bit[i]+"] [" + i + "] " + this.operand[this.type[i]] + " " + this.x1[i] + " " + this.y1[i] + " " + this.x2[i] + " " + this.y2[i], 2+intv,2+intv * (i+1))
                             if(i==this.pressedw)c.fillText("                                                                                                              PRESSED " + this.y2[i], 2+intv,2+intv * (i+1))
                             if(this.mstate[i]==1)c.fillText("                                                                                                               DOWN " + this.y2[i], 2+intv,2+intv * (i+1))
                             if(this.mstate[i]==2)c.fillText("                                                                                                               MOVE " + this.y2[i], 2+intv,2+intv * (i+1))
                             if(this.mstate[i]==3)c.fillText("                                                                                                             DRAG " + this.y2[i], 2+intv,2+intv * (i+1))

                              
                          //  c.restore();

                        }
 //if(this.bitmaps[this.bit[17]]!==undefined)c.drawImage(this.bitmaps[this.bit[17]], 100,100)



        }


        /*
        addscrollfon(file,x1,x2){
            this.pindex++;

            if(this.refresh[this.pindex]>0&&this.waitstart==false){

                i=this.pindex;
                this.mrk[i]=this.marki;
                this.type[i]=2;

                this.temp=loadbit(file);

                this.bitid=findb(file);
                this.bit[i]=this.bitid;

                this.x1[i]=x1;
                this.x2[i]=x2;
                this.y1[i]=0;
                this.y2[i]=Math.trunc(this.temp.height/(this.temp.with/(x2-x1)));

                bitmaps[bitid]=Bitmap.createBitmap(x2-x1,prt[i].y2,bc);
                Canvas cc=new Canvas(bitmaps[bitid]);
                cc.drawBitmap(temp,new Rect(0,0,temp.getWidth(),temp.getHeight()),new RectF(0,0,bitmaps[bitid].getWidth(),bitmaps[bitid].getHeight()),paint);

                temp.recycle();

                prt[i].id=-1;
                changebounds(0,w,0,h*2,prt[i]);
                if(prt[i].x1>1.0&&prt[i].x2>1.0){prt[i].chd=true;prt[i].refresh=0;}
                if(i>count)count=i;

            }

        }


*/


    }

    var CanvasToBMP = {

        /**
         * Convert a canvas element to ArrayBuffer containing a BMP file
         * with support for 32-bit (alpha).
         *
         * Note that CORS requirement must be fulfilled.
         *
         * @param {HTMLCanvasElement} canvas - the canvas element to convert
         * @return {ArrayBuffer}
         */
        toArrayBuffer: function(canvas) {

            var w = canvas.width,
                h = canvas.height,
                w4 = w * 4,
                idata = canvas.getContext("2d").getImageData(0, 0, w, h),
                data32 = new Uint32Array(idata.data.buffer),
                // 32-bit representation of canvas

                stride = Math.floor((32 * w + 31) / 32) * 4,
                // row length incl. padding
                pixelArraySize = stride * h,
                // total bitmap size
                fileLength = 122 + pixelArraySize,
                // header size is known + bitmap

                file = new ArrayBuffer(fileLength),
                // raw byte buffer (returned)
                view = new DataView(file),
                // handle endian, reg. width etc.
                pos = 0,
                x,
                y = 0,
                p,
                s = 0,
                a,
                v;

            // write file header
            setU16(0x4d42); // BM
            setU32(fileLength); // total length
            pos += 4; // skip unused fields
            setU32(0x7a); // offset to pixels

            // DIB header
            setU32(108); // header size
            setU32(w);
            setU32(-h >>> 0); // negative = top-to-bottom
            setU16(1); // 1 plane
            setU16(32); // 32-bits (RGBA)
            setU32(3); // no compression (BI_BITFIELDS, 3)
            setU32(pixelArraySize); // bitmap size incl. padding (stride x height)
            setU32(2835); // pixels/meter h (~72 DPI x 39.3701 inch/m)
            setU32(2835); // pixels/meter v
            pos += 8; // skip color/important colors
            setU32(0xff0000); // red channel mask
            setU32(0xff00); // green channel mask
            setU32(0xff); // blue channel mask
            setU32(0xff000000); // alpha channel mask
            setU32(0x57696e20); // " win" color space

            // bitmap data, change order of ABGR to BGRA
            while (y < h) {
                p = 0x7a + y * stride; // offset + stride x height
                x = 0;
                while (x < w4) {
                    v = data32[s++]; // get ABGR
                    a = v >>> 24; // alpha channel
                    view.setUint32(p + x, (v << 8) | a); // set BGRA
                    x += 4;
                }
                y++
            }

            return file;

            // helper method to move current buffer position
            function setU16(data) {
                view.setUint16(pos, data, true); pos += 2
            }
            function setU32(data) {
                view.setUint32(pos, data, true); pos += 4
            }
        },

        /**
         * Converts a canvas to BMP file, returns a Blob representing the
         * file. This can be used with URL.createObjectURL().
         * Note that CORS requirement must be fulfilled.
         *
         * @param {HTMLCanvasElement} canvas - the canvas element to convert
         * @return {Blob}
         */
        toBlob: function(canvas) {
            return new Blob([this.toArrayBuffer(canvas)], {
                type: "image/bmp"
            });
        },

        /**
         * Converts the canvas to a data-URI representing a BMP file.
         * Note that CORS requirement must be fulfilled.
         *
         * @param canvas
         * @return {string}
         */
        toDataURL: function(canvas) {
            var buffer = new Uint8Array(this.toArrayBuffer(canvas)),
                bs = "",
                i = 0,
                l = buffer.length;
            while (i < l) bs += String.fromCharCode(buffer[i++]);
            return "data:image/bmp;base64," + btoa(bs);
        }
    };





    function canvasApp() {

        var theCanvas = document.getElementById('canvasOne');
        theCanvas.width=window.innerWidth
        theCanvas.height= window.innerHeight
        var context = theCanvas.getContext('2d');
        width= theCanvas.width;
        height= theCanvas.width;
        e = new ec(theCanvas);
        // Debugger.log('Drawing Canvas');
        e.bitmaps = new Array(512)
//alert(window.innerWidth,window.innerHeight)
        // theCanvas.width = window.innerWidth;
        // theCanvas.height = window.innerHeight;


        context.fillStyle = randColor();
        context.fillRect(0, 0, theCanvas.width, theCanvas.height);

        window.onresize = function(event) {
            theCanvas.width = window.innerWidth;
            theCanvas.height = window.innerHeight;
            context.fillStyle = randColor();
            context.fillRect(0, 0, theCanvas.width, theCanvas.height);
        }

        window.requestAnimFrame = window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame || function(callback) {
            window.setTimeout(callback, 1000 / 60);
        }

        function randColor() {
            var r = Math.floor(Math.random() * 256),
                g = Math.floor(Math.random() * 256),
                b = Math.floor(Math.random() * 256),
                color = 'rgb($r,$g,$b)';

            color = color.replace('$r', r);
            color = color.replace('$g', g);
            color = color.replace('$b', b);

            return color;
        }

        function loop() {

            requestAnimationFrame(loop);
            update();

        }


        function rgb(r, g, b){
            r = Math.floor(r);
            g = Math.floor(g);
            b = Math.floor(b);
            return ["rgb(",r,",",g,",",b,")"].join("");
        }

        function drawCircle(ctx, x, y, radius, fill, stroke, strokeWidth) {
            ctx.beginPath()
            ctx.arc(x, y, radius, 0, 2 * Math.PI, false)
            if (fill) {
                ctx.fillStyle = fill
                ctx.fill()
            }
            if (stroke) {
                ctx.lineWidth = strokeWidth
                ctx.strokeStyle = stroke
                ctx.stroke()
            }
        }





deb=function(inp){
   obj.someProp=inp;

}
let sta=0

        var obj = {
            someProp: 10
        };

// save in another property
        obj._someProp = obj.someProp;

// overwrite with accessor
        Object.defineProperty(obj, 'someProp', {
            get: function () {
                return obj._someProp;
            },

            set: function (value) {
                if(sta!=value){
                    sta=value
                debugger; // sets breakpoint
               }
                obj._someProp = value;
            }
        });

        drag=false
        selectedk=0
        fit=999999999;
        selv=0;
        self=0
        seld=0

first=true;
loading=true;
TEST=-2;
DREVO=1;
SELECT=2;
NEWDREVO=3;
SPLASH=4;
FILESAVE=5;
FILEOPEN=6;
reg=-2;


let frame=[
			[112,62,400,384,79,475,427,608],
			[55,58,459,445,79,462,476,590],
			[55,47,463,508,77,507,441,578],
			[77,63,459,470,121,484,423,588],
			[68,58,454,531,94,540,432,657],
			[129,76,381,354,132,353,380,433],
			[106,46,410,500,106,512,417,592],
			[59,49,403,419,90,425,425,529],
			[59,49,403,419,90,425,425,529],
];

let label=[
			[1085,53,2350,293,1727,1868],
			[545,149,2081,485,1283,2536],
			[1044,119,2468,367,1684,1715],
			[1084,123,2592,471,1980,1555],
			[1147,111,2347,359,1715,1398],
			[1300,2184,2220,2356,1736,1684],
			[819,140,2390,380,1658,1744],
			[1398,1916,2056,2044,1706,1602],
			[0,0,0,0,0,0]
     ];

let opbitmap=false;

let uploadb;
uploadfile=function(){
        const inputElement = document.getElementById("input");
inputElement.addEventListener("change", handleFiles, false);
function handleFiles() {
    
  const fileList = this.files; 
  
 
  //e.bitmaps[ii].src = URL.createObjectURL(fileList[0]);
 // e.paths[ii]=URL.createObjectURL(fileList[0]);
  uploadb=URL.createObjectURL(fileList[0]);
 // console.log(uploadb)
  reg=SELECT
  e.refreshfull;

}
document.getElementById('input').value= null;
                    
                    document.getElementById('input').click();
                    
     
                    
}

exporti=false

let numf=3;
let fox=[64];
let foy=[64];

let numsv=0;
let fsv1=[64];//svyaz
let fsv2=[64];//svyaz2

let fsh=[64];//shirina ramki

let fos=[64];//text
let foto=[64];//n foto
let fpath=[64];//put zagr

let fotoi;

let  fcount=0;
let  seli=0;
let resizei=0;
let link=false;


addlink=function(l1,l2){
		numsv++;
		fsv1[numsv]=l1;
		fsv2[numsv]=l2;
	}

 delf=function(ind){

for(let j=0;j<=numsv;j++){
    if( fsv1[j]==ind){
        fsv1[j]=0;
    }
    if( fsv1[j]>ind){
        fsv1[j]=fsv1[j]-1;
    }
    if( fsv2[j]==ind){
        fsv2[j]=0;
    }
    if( fsv2[j]>ind){
        fsv2[j]=fsv2[j]-1;
    }
}

for(let i=ind;i<numf;i++){
    fox[i]=fox[i+1];
    foy[i]=foy[i+1];

    fos[i]=fos[i+1];
    foto[i]=foto[i+1];

}
numf--;

}

dellink=function(ind){
if(numsv>0){
    if(numf==1)numf=0;else{
        for(let j=1;j<=numsv;j++){
            if(fsv1[j]==ind||fsv2[j]==ind){
                for(let i=j;i<=numsv;i++){
                    fsv1[i]=fsv1[i+1];
                    fsv2[i]=fsv2[i+1];
                }//i
                numsv--;
                j--
            }//if
        }//j
    }//>1
}
}


        function update() {

           if(first){
             e.loadbitmap("load.jpg");
            
             if(e.bitmaps[e.findb("load.jpg")]!=undefined)first=false;
             reg=NEWDREVO;
             fox[1]=label[seld][4];
					foy[1]=label[seld][5];
					defsh=255;
					fsh[1]=255;

					fos[1]="Full name";
					for(let i=1;i<64;i++){
						foto[i]=0;
						fpath[i]="";
						fsh[i]=255;
					}
					fcount=0;
					numf=1;

					menu=0;

           }




    
            let w=e.w;
            let h=e.h;
            let wd=w/5;
            let ot=wd/6

if(reg==TEST){

e.start()
e.addoverlay(1,1,w,h,rgb(100,100,110))
e.addwbitmap("v1.png",10,10,50,fit)
e.addscrollbar(2,80,w,h-wd*3,rgb(200,200,180));
let win=e.pindex;
e.block();

e.addbitmap("d0.jpg",1,1);

e.addwbitmap("v1.png",100,150,200,fit)

if(e.mousedrag(e.pindex)){
   
   // console.log("coord" +e.mx+" "+e.my);
    e.x1[e.pindex]+=e.mvx;
    e.y1[e.pindex]+=e.mvy;
    e.x2[e.pindex]+=e.mvx;
    e.y2[e.pindex]+=e.mvy;
    e.noscroll=true;
}
e.processcrolling(win);
e.processzooming(win);

e.addoverlay(1,e.y2[win],w,h,rgb(100,100,110))
e.addwbitmap("tex.jpg",0,0,w,h)
e.addwbitmap("v1.png",100,100,150,fit)


e.updatebitmaps();
e.draw(theCanvas, context);





}





if(reg==DREVO){

   

e.start();

e.addscrollbar(2,2,w,h-wd*3,rgb(100,100,100));
let windowi=e.pindex;

let wwwi=e.wci;
if(e.mousedown(e.pindex)){
   // alert("changed");
  // console.log("mx= "+e.mx[windowi]+" my= "+e.my[windowi]+" zm="+e.zm[windowi] +" dx="+e.dx[windowi]+" dy="+e.dy[windowi]);

}
 e.addbitmap("d"+seld+".jpg",1,1);
if(e.changed(e.pindex)){
    
    loading=false;
    let iis=e.findb("d"+seld+".jpg");
    if(e.bitmaps[iis]!=undefined)	{
        if(e.bitmaps[iis].height<e.bitmaps[iis].width)
        e.fith(e.wci); else e.fitw(e.wci);
        e.refreshall();
    }
}


e.setid(7);//drevo
e.setlinewidth(30);
for(let i=1;i<=numsv;i++){
    if(fsv1[i]>0&&fsv2[i]>0)
        e.addline(fox[fsv1[i]],foy[fsv1[i]],fox[fsv2[i]],foy[fsv2[i]],rgb(220,150,20));
}


for(let i=1;i<=numf;i++){

    if(foto[i]>0){
        if(fpath[foto[i]]!=undefined){
        
        let ko=(fsh[i]*2)/512;
        let ftx1=frame[selv][0]*ko;
        let fty1=frame[selv][1]*ko;
        let ftx2=frame[selv][2]*ko;
        let fty2=frame[selv][3]*ko;
       //e.addwtext(fpath[foto[i]],((fox[i]-fsh[i])+ftx1),((foy[i]-fsh[i])+fty1),((fox[i]-fsh[i])+ftx2),((foy[i]-fsh[i])+fty2));
       
       e.addwbitmap(fpath[foto[i]],((fox[i]-fsh[i])+ftx1),((foy[i]-fsh[i])+fty1),((fox[i]-fsh[i])+ftx2),((foy[i]-fsh[i])+fty2));
        
        }

    }

    e.addwbitmap("v"+selv+".png",fox[i]-fsh[i],foy[i]-fsh[i],fox[i]+fsh[i],fit);
    if(resizei==i){e.setid(9);}//for resize 
    e.setid(1);//chel
    if(seli==i&&exporti==false){
        e.setlinewidth(2);
        e.addframe(e.ex1,e.ey1,e.ex2,e.ey2,rgb(255,255,0));
    }

    e.getid(1);
 let ko=(fsh[i]*2.0)/512;
 let ftx1=frame[selv][4]*ko;
 let fty1=frame[selv][5]*ko;
 let ftx2=frame[selv][6]*ko;
 let fty2=frame[selv][7]*ko;
   e.addwtext(fos[i],"font"+self+".ttf",fit,e.ex1+ftx1,e.ey1+fty1,e.ex1+ftx2,e.ey1+fty2,rgb(255,255,0));
   if(e.mousedown(e.id[1])){
    selectedk=i;
     
     seli=i;
        e.noscroll=true; 

   }
   
   
   if(e.pressed(e.id[1])){
      
       
       // e.refreshfull();
        if(link){
							e.copyprt(1);
							addlink(linki,i);
							link=false;
							e.refreshall();
							//e1.refreshfull();
							e.pasteprt(1);
							e.refresh[1]=1;
							e.key=0;
							menu=0;
							break;
						}else{
     menu=1;
    
            }

     
    }

    

    if(e.mouseup(windowi)){
        
      
        selectedk=0;
    }

}
    if(e.mousedrag(windowi)){
       // ii=e.n[e.wci]; 
       if(selectedk>0){
//console.log("drag "+selectedk)
        /* e.x1[e.dri]+=e.mvx;
         e.y1[e.dri]+=e.mvy;
         e.x2[e.dri]+=e.mvx;
         e.y2[e.dri]+=e.mvy;*/
          fox[selectedk]+=e.mvx;
           foy[selectedk]+=e.mvy;
           e.noscroll=true;
         //fox[selectedk]=e.mx;
         //foy[selectedk]=e.my;





        e.refreshall();
       }

    
    }
e.processcrolling(windowi);
    e.processzooming(windowi);
   

if(resizei>0){
    e.getid(9);
//console.log(e.epi);
    e.addanimbitmap("2242.png",2,1,0,e.ex2,e.ey2,e.ex2+wd,e.ey2+wd);
    e.setid(3);
    if(e.mousedown(e.id[3])){
       // console.log("uu"+resizei)
       if(resizei>0){
        e.k[e.epi]=1;

        e.noscroll=true;
        e.key=0;
        }else{
          defsh=fsh[seli];
          e.noscroll=false
        resizei=0;
        
        e.refreshall();
        e.key=0;
        }
    }
    if(e.mousedrag(e.id[3])){
      //  int ii=e1.prt[e.wci].n;
       
        e.x1[e.pindex]+=e.mvx; 
        e.y1[e.pindex]+=e.mvy;

        e.x2[e.pindex]+=e.mvx;
        e.y2[e.pindex]+=e.mvy;
        
        fsh[seli]+=e.mvx;
        
        defsh=fsh[seli];
        e.refreshall();
        e.key=0;
    }
    /*if(e.mousedown(e.epi)){
        

    }*/

}

/*
e1.addwtext(labels,"font"+String.valueOf(self)+".ttf",fit,label[seld][0]-5,label[seld][1]-5,label[seld][2]-5,label[seld][3]-5,Color.BLACK);

e1.addwtext(labels,"font"+String.valueOf(self)+".ttf",fit,label[seld][0],label[seld][1],label[seld][2],label[seld][3],Color.YELLOW);
if(e1.pressed(e1.pindex)){
    texti=999;
    labi=e1.pindex;
    inputs(tr("Change the label"),labels);

}

e1.addframe(0,0,e1.prt[e1.wci].sx,e1.prt[e1.wci].sy,Color.RED);

e1.mark(1);

e1.mark(4);//menu
*/

e.addoverlay(2,w,w,h);
e.addwbitmap("tex.jpg",1,h-wd*3,w,h);
if(menu==1&&e.waitstart==false){//podgotovka popup

    for(let h=1;h<16;h++){
        e.an[e.pindex+h]= 300;
        e.n[e.pindex+h]=1;
        e.an1[e.pindex+h]=performance.now();
        e.refresh[e.pindex+h]=1;
    }
    e.refreshall();
   
    menu=2;
}
if((menu==2)&(e.waitstart==false)){

    e.addanimbitmap("button.png",1,3,1,1,h-wd*3,w/2,fit);

let but=e.pindex
//log=String.valueOf(e1.sprt[2].an);
    e.setid(2);//dobchel

    e.addwtext("Add the human","font0.ttf",fit,e.ex1+ot,e.ey1+ot,e.ex2-ot,e.ey2-ot,rgb(255,255,255));

    //e1.sprt[2].refresh=0;
    if(e.pressed(but)){

        
        e.k[e.epi]=2;
       // e.copyprt(1);
        e.getid(1);
        numf++;
        addlink(seli,numf);
        fox[numf]=fox[seli];
        foy[numf]=foy[seli]-fsh[seli];
        fsh[numf]=defsh;


        fos[numf]="Full name";

        e.refreshall();

        //	e1.pasteprt(1);
    
//alert("add["+numf+"] "+fox[numf]+" "+foy[numf]+" "+fsh[numf])
        //e.waitstart();


        e.key=0;
        menu=0;
    }



    e.addanimbitmap("button.png",1,3,1,e.ex1,e.ey2,e.ex2,fit);
    //log=String.valueOf(e1.sprt[2].an);
    e.setid(2);//dobchel
    //log=String.valueOf(e1.prt[e1.pindex].an);
    e.addwtext("Delete","font0.ttf",fit,e.ex1+ot,e.ey1+ot,e.ex2-ot,e.ey2-ot,rgb(255,255,255))
   // e.sprt[2].refresh=0;
    if(e.pressed(e.epi)){
        e.k[e.epi]=2;
        e.getid(1);
        for(let i=0;i<=numsv;i++){
            if(fsv2[i]==i)
                dellink(i);
        }
        dellink(seli);
        delf(seli);

        e.refreshfull();
        e.refresh[1]=0;
        menu=0;

    }
    e.addanimbitmap("button.png",1,3,1,e.ex1,e.ey2,e.ex2,fit);
    //log=String.valueOf(e1.sprt[2].an);
    e.setid(2);//dobchel
    //log=String.valueOf(e1.prt[e1.pindex].an);
    if(link){e.addwtext("Link with","font0.ttf",fit,e.ex1+ot,e.ey1+ot,e.ex2-ot,e.ey2-ot,rgb(255,255,255));}
    else e.addwtext("Link","font0.ttf",fit,e.ex1+ot,e.ey1+ot,e.ex2-ot,e.ey2-ot,rgb(255,255,255));



    if(e.pressed(e.epi)){
        e.getid(1);
        e.k[e.epi]=2;

        link=true;
        //e1.prt[e1.epi].value=0;
        linki=seli;

e.refresh[e.pindex]=2;
        e.refreshall();



        e.key=0;


    }
    
    e.addanimbitmap("button.png",1,3,1,e.ex1,e.ey2,e.ex2,fit);
    e.setid(2);//dobchel
    if(e.pressed(e.epi)){
        e.k[e.epi]=2;
        dellink(seli);
        e.refreshfull();

    }
    e.addwtext("Remove links","font0.ttf",fit,e.ex1+ot,e.ey1+ot,e.ex2-ot,e.ey2-ot,rgb(255,255,255));
    

    e.addanimbitmap("button.png",1,3,1,w/2,h-wd*3,w,fit);
    //log=String.valueOf(e1.sprt[2].an);\
    e.setid(2);//dobchel
    //log=String.valueOf(e1.prt[e1.pindex].an);
    e.addwtext("Photo","font0.ttf",fit,e.ex1+ot,e.ey1+ot,e.ex2-ot,e.ey2-ot,rgb(255,255,255));
    if(e.pressed(e.pindex)){


        e.getid(1);
        e.k[e.epi]=2;
        e.copyprt(1);
      
        fotoi=seli;
        uploadfile(); 

        reg=SELECT;
        menu=0;
        loading=true;
        e.refreshfull();
  

    }


    e.addanimbitmap("button.png",1,3,1,e.ex1,e.ey2,e.ex2,fit);

    e.setid(2);//dobchel

    e.addwtext("Text","font0.ttf",fit,e.ex1+ot,e.ey1+ot,e.ex2-ot,e.ey2-ot,rgb(255,255,255));
    if(e.mousedown(e.epi)){
        e.getid(1);
        e.copyprt(1);
        e.value[e.epi]=0;
        texti=seli;
        fos[seli]= window.prompt("Vvedi FIO", fos[seli]);
        menu=0;
        e.refreshall();
      
        e.key=0;

    }
    e.addanimbitmap("button.png",1,3,1,e.ex1,e.ey2,e.ex2,fit);
    //log=String.valueOf(e1.sprt[2].an);
    e.setid(2);//dobchel
    //log=String.valueOf(e1.prt[e1.pindex].an);
    e.addwtext("Resize","font0.ttf",fit,e.ex1+ot,e.ey1+ot,e.ex2-ot,e.ey2-ot,rgb(255,255,255));
    if(e.mousedown(e.epi)){
        e.getid(1);
        e.copyprt(1);
        e.value[e.epi]=0;
       
        resizei=seli;

        // reg=SELECT;
        menu=0;
        e.refreshall();
       
        e.key=0;

    }

}
/*
if(menu==3&&e1.waitstart==false){//podgotovka popup

    for(int h=1;h<12;h++){
        e1.prt[e1.pindex+h].an=25f;
        e1.prt[e1.pindex+h].n=0;
        e1.prt[e1.pindex+h].sp=-5;
        e1.prt[e1.pindex+h].refresh=1;
    }
    e1.refreshall();
    menu=4;
}
if((menu==4)&(e1.waitstart==false)) {

    e1.addanimbitmap("button.png", 1, 3, 1, 1, h - wd * 3, w / 2, fit);
    //e1.addanimbitmap("button.png",1,3,1,1,800,640,fit);


    //log=String.valueOf(e1.sprt[2].an);
    e1.setid(2);//dobchel

    e1.addbtext(tr("New tree"), "font0.ttf", fit, e1.ex1 + 30, e1.ey1 + 20, e1.ex2 - 30, e1.ey2 - 10, Color.WHITE);

    //e1.sprt[2].refresh=0;
    if (e1.pressed(e1.epi)) {
        e1.prt[e1.epi].k = 2;
        //e1.copyprt(1);
        e1.getid(1);
        numsv = 0;

        reg = SPLASH;

        e1.refreshfull();
        //	e1.pasteprt(1);

        e1.waitstart();


        e1.key = 0;
        menu = 0;
    }


    e1.addanimbitmap("button.png", 1, 3, 1, e1.ex1, e1.ey2, e1.ex2, fit);
    //log=String.valueOf(e1.sprt[2].an);
    e1.setid(2);//dobchel
    //log=String.valueOf(e1.prt[e1.pindex].an);
    e1.addbtext(tr("Save tree"), "font0.ttf", fit, e1.ex1 + 30, e1.ey1 + 20, e1.ex2 - 30, e1.ey2 - 10, Color.WHITE);

    e1.sprt[2].refresh = 0;
    if (e1.pressed(e1.epi)) {
        e1.prt[e1.epi].k = 2;
        e1.getid(1);

        reg = FILESAVE;
        File directory = new File(cont.getExternalFilesDir(null).getAbsolutePath() + "/.drevo/");
        File[] infiles = directory.listFiles();
        files = new String[infiles.length];
        //sm(String.valueOf(files.length));
        int ii = 0;
        for (int i = 0; i < files.length; i++) {
            if (getExt(infiles[i].getName()).equals("dre")) {
                if (infiles[i].getName() == null) files[ii] = "null";
                else
                    files[ii] = infiles[i].getName().substring(0, infiles[i].getName().length() - 4);
                ii++;
            }
        }
        filesc = ii;
        //savedrevo("");


        e1.refreshfull();
        e1.waitstart();
        e1.key = 0;
        menu = 0;

    }
    e1.addanimbitmap("button.png", 1, 3, 1, e1.ex1, e1.ey2, e1.ex2, fit);
    //log=String.valueOf(e1.sprt[2].an);
    e1.setid(2);//dobchel
    //log=String.valueOf(e1.prt[e1.pindex].an);
    e1.addbtext(tr("Open tree"), "font0.ttf", fit, e1.ex1 + 30, e1.ey1 + 20, e1.ex2 - 30, e1.ey2 - 10, Color.WHITE);


    if (e1.pressed(e1.epi)) {
        e1.getid(1);
        e1.prt[e1.epi].k = 2;
        //e1.copyprt(1);

        if (outfile.equals("newfile"))
            outfile = "Demo";

        reg = FILEOPEN;
        File directory = new File(cont.getExternalFilesDir(null).getAbsolutePath() + "/.drevo/");
        File[] infiles = directory.listFiles();
        files = new String[infiles.length];
        //sm(String.valueOf(files.length));
        //sm(String.valueOf(files.length));
        int ii = 0;
        for (int i = 0; i < files.length; i++) {
            if (getExt(infiles[i].getName()).equals("dre")) {
                if (infiles[i].getName() == null) files[ii] = "null";
                else
                    files[ii] = infiles[i].getName().substring(0, infiles[i].getName().length() - 4);
                ii++;
            }
        }
        filesc = ii;
        //savedrevo("");


        e1.refreshfull();
        e1.waitstart();
        e1.key = 0;
        menu = 0;

    }

    e1.addanimbitmap("button.png", 1, 3, 1, w / 2, h - wd * 3, w, fit);
    //log=String.valueOf(e1.sprt[2].an);
    e1.setid(2);//dobchel
    //log=String.valueOf(e1.prt[e1.pindex].an);
    e1.addbtext(tr("Export Image"), "font0.ttf", fit, e1.ex1 + 30, e1.ey1 + 20, e1.ex2 - 30, e1.ey2 - 10, Color.WHITE);
    if (e1.pressed(e1.epi)) {
        if (label[8][0] == 1) {
            export = true;
            e1.refreshall();
            e1.getid(1);
            e1.prt[e1.epi].k = 2;
            e1.copyprt(1);
            e1.prt[1].zm = 1f;
            int i = 0;
            do {
                i++;
                //vrem uber ramki
                if (e1.prt[i].type == 12) e1.prt[i].type = 89;
            } while (i < 64 && e1.prt[i].type != 5);
            int tempi = e1.count;

            e1.pindex = i;
            sm(tr("photo saved to pictures dir"));

            int bid = e1.findb("d" + seld + ".jpg");
            Canvas cnv = new Canvas(e1.bitmaps[bid]);
            e1.prt[1].type = 0;
            e1.paint.setAntiAlias(true);
            e1.draw(cnv);
            e1.paint.setAntiAlias(false);

            try {
                savejpeg(e1.bitmaps[bid],  outfile + ".jpg");
            } catch (IOException e) {
                e.printStackTrace();
            }
            e1.prt[1].type = 8;

            e1.count = tempi;

            e1.pasteprt(1);
            e1.key = 0;
            menu = 0;
            export = false;
            //stavim ramki
            for (int j = 0; j <= e1.count; j++) {
                if (e1.prt[i].type == 89) e1.prt[i].type = 12;

            }


            e1.refreshfull();
            e1.waitstart();
            e1.key = 0;
        } else {
            sm(tr("Purchase full version please"));


        }
    }

    if (label[8][0] != 1) {
        e1.addanimbitmap("button.png", 1, 3, 1, e1.ex1, e1.ey2, e1.ex2, fit);
        //log=String.valueOf(e1.sprt[2].an);
        e1.setid(2);//dobchel
        //log=String.valueOf(e1.prt[e1.pindex].an);
        e1.setshadow(0, Color.BLACK);
        e1.addbtext(tr("Purchase"), "font0.ttf", fit, e1.ex1, e1.ey1, e1.ex2, e1.ey2, Color.WHITE);
        if (e1.pressed(e1.epi)) {
            e1.getid(1);
            e1.copyprt(1);
            e1.prt[e1.epi].value = 0;
            buy("fullimage");

            e1.key = 0;

        }

    }


}


*/



e.updatebitmaps();

   
/*for (var i = 0; i <= numsv; i++) {
context.fillText("fsv1= "+fsv1[i]+" fsv2="+fsv2[i], 50, 15 * (i+1))
        
     
     
 }
*/


e.draw(theCanvas, context);
//let fff=performance.now()-hh 
//onsole.log(fff)
}//DREVO

if(reg==NEWDREVO){      
            e.start()

            e.addoverlay(1,1,w,h);
          // e.addwtext("over","font0.ttf",fit,1,1,wd*2,wd);
           
           e.addanimbitmap("anim.png",3,1,1,wd, h-wd*1.3,w-wd,h-wd*0.5);e.setid(1);
                    if(e.k[e.pindex]>0)e.k[e.pindex]--;
                  if(e.mousedown(e.pindex)){
                      reg=DREVO;
                      e.refreshall()
                   //uploadfile(); 



                     //
                        e.k[e.pindex]=3
                     
                    }
                    e.setid(1);
            e.addwtext("Ds,hfnmms dfs fsdfsdfsdgs sdfgsdggs  gsd gsdgsdg", "font0", fit, e.ex1, e.ey1, e.ex2, e.ey2)
  



            e.addscrollbar(1,wd,w,wd*3,rgb(100,100,100));
            e.processcrolling(e.pindex);
            e.processzooming(e.pindex);
            e.block(e.pindex);
     
				e.addwbitmap("d0.jpg",1,1,fit,wd*2);
                if(e.mousedown(e.pindex)){
                        seld=0;
                        e.refreshall();
                    }
				e.setid(5);//dr
				e.setlinewidth(5);
				if(seld==0)e.addframe(e.ex1+5,e.ey1+5,e.ex2-5,e.ey2-5,rgb(255,255,100));
				for(let i=1;i<4;i++){

					e.addwbitmap("d"+i+".jpg",e.ex2,1,fit,wd*2);
                    if(e.mousedown(e.pindex)){
                        seld=i;
                        
                        e.refreshall();
                    }
					e.setid(5);//dr
				if(seld==i)e.addframe(e.ex1,e.ey1,e.ex2,e.ey2,rgb(255,255,100));

				}

				e.addscrollbar(1,wd*3,w,wd*5,rgb(250,100,100));
                e.processcrolling(e.pindex);
                e.processzooming(e.pindex);
                e.block(e.pindex);

				e.addwbitmap("v0.png",1,1,fit,wd*2);
                e.setid(5);//dr
				if (e.mousedown(e.pindex)){
					selv=0;
					e.refreshall();
				}
				e.setlinewidth(5);
				if(selv==0)e.addframe(e.ex1,e.ey1,e.ex2,e.ey2,rgb(255,255,100));
				for(let i=1;i<4;i++){
					e.addwbitmap("v"+i+".png",e.ex2,0,fit,wd*2);
                    e.setid(5);//dr
                    if(e.mousedown(e.pindex)){
                        selv=i;
                       
                        e.refreshall();
                    }
					if(selv==i)e.addframe(e.ex1,e.ey1,e.ex2,e.ey2,rgb(255,255,100));
				}
				e.addscrollbar(1,wd*5,w,wd*5.8,rgb(100,100,100));
                e.processcrolling(e.pindex);
                e.processzooming(e.pindex);
                e.block(e.pindex);

				e.addwtext("Text"+0,"font0.ttf",fit,1,1,wd*2,wd);e.setid(1);//dr
                if(e.mousedown(e.pindex)){
                        self=0;
                        e.refreshall();
                    }
                e.setlinewidth(5);
				if(self==0)e.addframe(1,1,wd*2,wd,rgb(255,255,100));
                
				for(let i=1;i<4;i++){
					e.addwtext("Text"+i,"font"+i+".ttf",fit,e.ex2,1,e.ex2+wd*2,wd);e.setid(1);//dr
                    if(e.mousedown(e.pindex)){
                        self=i;
                        e.refreshall();
                    }
                    
					if(self==i)e.addframe(e.ex1,e.ey1,e.ex2,e.ey2,rgb(255,255,100));
                }
	
			
          if(!e.waitstart){
            context.fillStyle="rgb(111,175,123)";
            context.fillRect(0, 0, theCanvas.width, theCanvas.height);
            context.fillStyle="rgb(255,0,0)"
         }
        
         if(loading){  context.fillStyle="rgb(111,175,123)";
        e.addoverlay(0,0,w,h) 
         e.addanimbitmap("load.jpg",9,9,1,1,1,w,h)
         e.k[e.pindex]++;
         if(e.k[e.pindex]>9)e.k[e.pindex]=0;
         //context.fillRect(0, 0, theCanvas.width, theCanvas.height);
            context.fillStyle="rgb(255,175,123)";
           context.fillText("LOADING",200+Math.random() *40,200+Math.random() *40);
               loading=e.loading;
        } 
           
            e.updatebitmaps();
			e.draw(theCanvas, context);
    }//NEW DREVO

if(reg==SELECT){
let mb;
if(opbitmap==false){

//mb=e.findb(uploadb);
e.refreshfull();
// e1.prt[2].refresh=1;
opbitmap=true;
}
e.start();



let ko=w/512;

e.addscrollbar(frame[selv][0]*ko,frame[selv][1]*ko,frame[selv][2]*ko,frame[selv][3]*ko,rgb(255,255,255));
let canvasi=e.pindex;
 e.processzooming(e.pindex)
 e.processcrolling(e.pindex)



// e1.addscrollbar(2,2,w,h);

e.addbitmap(uploadb,1,1);



//e1.addanimbitmap("button.png",1,3,1,wd,w,w-wd,w+wd);
//log="isisiis"+String.valueOf(ko);
e.addoverlay(0,0,w,h);

e.addwbitmap("v"+selv+".png",1,1,w,fit);
e.setid(1);
e.getid(1);

e.addanimbitmap("button.png",1,3,1,wd,e.ey2,w-wd,fit);

e.setid(7);//console.log("sset "+e.ex1+" "+e.ey1+" "+e.ex2+" "+e.ey2)
if(e.mousedown(e.pindex)){
  //e.refreshfull();

e.k[e.pindex]=2;  
fcount++;

foto[fotoi]=fotoi;

fpath[fotoi] =e.cropcanvastobase64(canvasi);


e.deletebit(e.findb(uploadb))
uploadb=undefined;

//alert(fotoi+" "+fpath[fotoi]);

fos[seli] = window.prompt("Vvedi FIO", "");


foto[fotoi]=fotoi;

reg=DREVO;
texti=seli;



menu=0;

e.refreshfull();
/*
let x1=e.dx[1];
let y1=e.dy[1];
let x2=e.dx[1]+(((e.x2[1]-e.x1[1])/e.zm[1]));
let y2=e.dy[1]+(((e.y2[1]-e.y1[1])/e.zm[1]));


fpath[fotoi] = fotoi;



                  if(this.paths[i].indexOf("http:")==-1)  this.bitmaps[i].src="res/"+this.paths[i].replace("-",""); else this.bitmaps[i].src=this.paths[i];
                    this.bitmaps[i].onload=()=>{
                        //alert(this.bitmaps[i].width);
					}
//sm(String.valueOf(x1)+" "+String.valueOf(x2)+" "+String.valueOf(y1)+" "+String.valueOf(y2));

temp= Bitmap.createBitmap((x2-x1),(y2-y1),Bitmap.Config.ARGB_8888);
Canvas c=new Canvas(temp);
int mo=e1.findb("d"+String.valueOf(seld)+".jpg");
c.drawBitmap(e1.bitmaps[mo],new Rect(x1,y1,x2,y2),new RectF(0,0,(x2-x1),(y2-y1)),paint);
saveImagejpeg(temp,cont.getExternalFilesDir(null).getAbsolutePath()+"/.drevo/temp/f"+String.valueOf(fotoi)+".jpg");
fpath[fotoi]="sdcard/.drevo/temp/f"+String.valueOf(fotoi)+".jpg";
e1.bitmaps[e1.findb(fpath[fotoi])]=null;
foto[fotoi]=fotoi;

reg=DREVO;
texti=seli;
inputs(tr("Sign photo"),fos[seli]);


menu=0;


e1.refreshfull();
e1.waitstart();
e1.pasteprt(1);
e1.prt[1].refresh=1;
*/


}
e.getid(7);

//e.setshadow(Color.BLACK,-5);
//e.addframe(e.ex1,e.ey1,e.ex2,e.ey2,rgb(255,0,0));
e.addwtext("Crop face","font0.ttf",fit,e.ex1,e.ey1,e.ex2,e.ey2,rgb(255,255,255));

//e.setshadow(Color.BLACK,0);

if(!e.waitstart){
            context.fillStyle="rgb(111,175,123)";
            context.fillRect(0, 0, theCanvas.width, theCanvas.height);
            context.fillStyle="rgb(255,0,0)"
         }
e.updatebitmaps()
e.draw(theCanvas, context);


}

        }//MAIN LOOP


        // drawScreen();

        loop();
    }

</script>
</body>

</html>
